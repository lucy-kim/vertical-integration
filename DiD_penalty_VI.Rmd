---
title: "DiD analysis of the impact of readmissions penalty on vertical integration"
author: "Lucy Kim"
date: "1/16/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())

library(ggplot2)
library(zoo)
library(plyr)
source("~/Dropbox/Wharton/Research/Labor/code/summarySE.R")


```

# Import PAC type-hospital-fy-condition level data
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/Medicare/hosp_fy_VI.csv")
df <- subset(df, fy!=2008) # drop 2008 b/c it's only second half of 2008
df$condition <- factor(df$condition, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))
df$size <- factor(df$size, labels = c("30-100","101-300","301+"))

df$cond2 <- factor(ifelse(df$condition!="Hip/Knee",1,2), labels = c("AMI, HF, PN", "Hip/Knee"))
df$refhhi3[df$cond2=="Hip/Knee"] <- df$refhhi[df$cond2=="Hip/Knee"]
```

# Descriptive analysis of the trend

## Trend in # discharges
```{r}
df.h <- ddply(df, .(provid,fy,size,condition), summarise, disch = mean(dischnum))

df.h2 <- summarySE(df.h, measurevar="disch", groupvars=c("fy","condition"))

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right

# Use 95% confidence interval instead of SEM
ggplot(df.h2, aes(x=fy, y=disch)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=disch-ci, ymax=disch+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,180)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean total number of discharges in a hospital",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/dischnum.png", width = 15, height=15, units="cm")

df.h3 <- summarySE(df.h, measurevar="disch", groupvars=c("size","fy","condition"))

ggplot(df.h3, aes(x=fy, y=disch, colour=size)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=disch-ci, ymax=disch+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,320)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean total number of discharges in a hospital",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/dischnum_bysize.png", width = 15, height=15, units="cm")
```


## Trend in share of discharges referred to PAC

don't exclude 2008
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/Medicare/hosp_fy_VI.csv")
df$condition <- factor(df$condition, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))
df$size <- factor(df$size, labels = c("30-100","101-300","301+"))

df$cond2 <- factor(ifelse(df$condition!="Hip/Knee",1,2), labels = c("AMI, HF, PN", "Hip/Knee"))
df$refhhi3[df$cond2=="Hip/Knee"] <- df$refhhi[df$cond2=="Hip/Knee"]

#create share of referrals
df$shref <- 100*df$dischnum_pac / df$dischnum

# create penalty pressure
df$pnlt3 <- factor(ifelse(df$pnltr13==0, 1,ifelse(df$pnltr13 >0.0034,2,3)), labels = c("Not penalized", "Penalized, bottom half", "Penalized, top half"))
# ddply(df, .(pnlt3), summarise, M=mean(pnltr13))
```


Mean share of referrals
```{r}
df.h2 <- summarySE(df, measurevar="shr", groupvars=c("pac","fy","condition"), na.rm=T)

df.h3 <- subset(df.h2, pac=="SNF")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=shr)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=shr-ci, ymax=shr+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean percentage of hospital discharges referred to SNF",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/shref_SNF.png", width = 15, height=15, units="cm")

df.h3 <- subset(df.h2, pac=="HHA" & fy >= 2011)

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=shr)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=shr-ci, ymax=shr+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_continuous(limits = c(2011,2016),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean percentage of hospital discharges referred to HHA",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/shref_HHA.png", width = 15, height=15, units="cm")

# by size
df.h4 <- summarySE(df.h, measurevar="shr", groupvars=c("pac","fy","condition","size"), na.rm=T)

df.h3 <- subset(df.h4, pac=="SNF")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=shr, colour=size)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=shr-ci, ymax=shr+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_continuous(limits = c(2008.8,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean percentage of hospital discharges referred to SNF",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/shref_SNF_bysize.png", width = 15, height=15, units="cm")

df.h3 <- subset(df.h4, pac=="HHA" & fy >= 2011)

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=shr, colour=size)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=shr-ci, ymax=shr+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_continuous(limits = c(2010.8,2016.2),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean percentage of hospital discharges referred to HHA",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/shref_HHA_bysize.png", width = 15, height=15, units="cm")

```

### growth of share of referrals by penalty
```{r}
df.h <- ddply(df, .(pac,provid,fy,pnlt3,condition), summarise, shref = mean(shref, na.rm=TRUE))
# df.h <- ddply(df, .(pac,provid,fy,pnltr13_p75,condition), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))

# calculate growth rate
df.h <- df.h[order(df.h$pac,df.h$condition,df.h$provid,df.h$fy),]
df.h2 <- ddply(df.h,.(pac, condition, provid),transform,
         Growth=c(NA,exp(diff(log(shref)))-1))
df.h2$Growth <- 100*df.h2$Growth
df.h2$Growth[is.infinite(df.h2$Growth)] <- NA 
summary(df.h2$Growth)

# aggregate mean growth
df.h3 <- summarySE(df.h2, measurevar="Growth", groupvars=c("pac","fy","condition","pnlt3"), na.rm=T)
df.h3 <- subset(df.h3, is.na(pnlt3)==F)
# df.h3$pnlt3 <- factor(df.h3$pnlt3, labels = c("Low penalty pressure", "High penalty pressure"))

df.h4 <- subset(df.h3, pac=="SNF")

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  # scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2008.8,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral share (%)",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size=8) +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grshref_SNF_bypnltprs.png", width = 15, height=15, units="cm")


df.h4 <- subset(df.h3, pac=="HHA" & fy >= 2011)

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  # scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2011,2016.2),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of HHA referral concentration (%)",
       subtitle="By penalty rate in 2013 and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grshref_HHA_bypnltprs.png", width = 15, height=15, units="cm")

```


## Trend in PAC referral concentration 
plot raw means
```{r}
df.h <- ddply(df, .(pac,provid,fy,size,cond2), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))

# aggregate mean growth
df.h2 <- summarySE(df.h, measurevar="refhhi3", groupvars=c("pac","fy","cond2","size"), na.rm=T)

df.h3 <- subset(df.h2, pac=="SNF")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=size)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,0.5)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean SNF referral concentration",
       subtitle="By hospital size and condition") +
  theme_bw() +
    theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_SNF_bysize.png", width = 15, height=15, units="cm")

df.h3 <- subset(df.h2, pac=="HHA" & fy >= 2011)

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=size)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,0.7)) +
  scale_x_continuous(limits = c(2011,2016),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean HHA referral concentration",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_HHA_bysize.png", width = 15, height=15, units="cm")
```


### mean level by penalty status
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/Medicare/hosp_fy_VI.csv")
# df <- subset(df, fy!=2008) # drop 2008 b/c it's only second half of 2008
df$condition <- factor(df$condition, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))
df$size <- factor(df$size, labels = c("30-100","101-300","301+"))

df$cond2 <- factor(ifelse(df$condition!="Hip/Knee",1,2), labels = c("AMI, HF, PN", "Hip/Knee"))
df$refhhi3[df$cond2=="Hip/Knee"] <- df$refhhi[df$cond2=="Hip/Knee"]

df$pnlt3 <- factor(ifelse(df$pnltr13==0, 1,ifelse(df$pnltr13 >0.0034,2,3)), labels = c("Not penalized", "Penalized, bottom half", "Penalized, top half"))
# ddply(df, .(pnlt3), summarise, M=mean(pnltr13))

df.h <- ddply(df, .(pac,provid,fy,pnlt3,cond2), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))
# df.h <- ddply(df, .(pac,provid,fy,pnltr13_p75,cond2), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))

# aggregate mean growth
df.h2 <- summarySE(df.h, measurevar="refhhi3", groupvars=c("pac","fy","cond2","pnlt3"), na.rm=T)

df.h3 <- subset(df.h2, pac=="SNF" & cond2!="Hip/Knee")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=pnlt3)) + 
  # facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(0,0.3)) +
  scale_x_continuous(limits = c(2007.8,2016),
                     breaks= seq(2008,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean SNF referral concentration for AMI, HF, PN",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size = 7) +
    theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_SNF_bypnlt3_3c.png", width = 10, height=7, units="cm")

df.h3 <- subset(df.h2, pac=="SNF" & cond2=="Hip/Knee")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=pnlt3)) + 
  # facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(0,0.5)) +
  scale_x_continuous(limits = c(2007.8,2016),
                     breaks= seq(2008,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean SNF referral concentration for HK",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size = 7) +
    theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_SNF_bypnlt3_hk.png", width = 10, height=7, units="cm")


df.h3 <- subset(df.h2, pac=="HHA" & fy >= 2011)

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=pnlt3)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,0.7)) +
  scale_x_continuous(limits = c(2011,2016),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean HHA referral concentration",
       subtitle="By penalty rate in 2013 and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_HHA_bypnlt3.png", width = 15, height=15, units="cm")
```


Plot growth rate
```{r}
# calculate growth rate
df.h <- df.h[order(df.h$pac,df.h$cond2,df.h$provid,df.h$fy),]
df.h2 <- ddply(df.h,.(pac, cond2, provid),transform,
         Growth=c(NA,exp(diff(log(refhhi3)))-1))
df.h2$Growth <- 100*df.h2$Growth
df.h2$Growth[is.infinite(df.h2$Growth)] <- NA 
summary(df.h2$Growth)

# aggregate mean growth
df.h3 <- summarySE(df.h2, measurevar="Growth", groupvars=c("pac","fy","cond2"), na.rm=T)

df.h4 <- subset(df.h3, pac=="SNF")

ggplot(df.h4, aes(x=fy, y=Growth)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,20)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral concentration (%)",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_SNF.png", width = 15, height=15, units="cm")

df.h4 <- subset(df.h3, pac=="HHA" & fy >= 2011)

ggplot(df.h4, aes(x=fy, y=Growth)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,20)) +
  scale_x_continuous(limits = c(2011,2016),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of HHA referral concentration (%)",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_HHA.png", width = 15, height=15, units="cm")


# by size

# aggregate mean growth
df.h3 <- summarySE(df.h2, measurevar="Growth", groupvars=c("pac","fy","cond2","size"), na.rm=T)

df.h4 <- subset(df.h3, pac=="SNF")

ggplot(df.h4, aes(x=fy, y=Growth, colour=size)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2009,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral concentration (%)",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_SNF_bysize.png", width = 15, height=15, units="cm")

df.h4 <- subset(df.h3, pac=="HHA" & fy >= 2011)

ggplot(df.h4, aes(x=fy, y=Growth, colour=size)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2011,2016.2),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of HHA referral concentration (%)",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_HHA.png", width = 15, height=15, units="cm")
```

### growth rate by penalty status
```{r}
df$pnlt3 <- factor(ifelse(df$pnltr13==0, 1,ifelse(df$pnltr13 >0.0034,2,3)), labels = c("Not penalized", "Penalized, bottom half", "Penalized, top half"))
# ddply(df, .(pnlt3), summarise, M=mean(pnltr13))
df.h <- ddply(df, .(pac,provid,fy,pnlt3,cond2), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))

# calculate growth rate
df.h <- df.h[order(df.h$pac,df.h$cond2,df.h$provid,df.h$fy),]
df.h2 <- ddply(df.h,.(pac, cond2, provid),transform,
         Growth=c(NA,exp(diff(log(refhhi3)))-1))
df.h2$Growth <- 100*df.h2$Growth
df.h2$Growth[is.infinite(df.h2$Growth)] <- NA 
summary(df.h2$Growth)

# aggregate mean growth
df.h3 <- summarySE(df.h2, measurevar="Growth", groupvars=c("pac","fy","cond2","pnlt3"), na.rm=T)
df.h3 <- subset(df.h3, is.na(pnlt3)==F)
# df.h3$pnlt3 <- factor(df.h3$pnlt3, labels = c("Low penalty pressure", "High penalty pressure"))

df.h4 <- subset(df.h3, pac=="SNF" & cond2!="Hip/Knee")

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + 
  # facet_grid(pnlt3~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2008.8,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral concentration for AMI, HF, PN (%)",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size=8) +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_SNF_bypnltprs_3c.png", width = 10, height=7, units="cm")

df.h4 <- subset(df.h3, pac=="SNF" & cond2=="Hip/Knee")

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + 
  # facet_grid(pnlt3~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2008.8,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral concentration for HK (%)",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size=8) +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_SNF_bypnltprs_hk.png", width = 10, height=7, units="cm")


df.h4 <- subset(df.h3, pac=="HHA" & fy >= 2011)

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2011,2016.2),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of HHA referral concentration (%)",
       subtitle="By penalty pressure and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_HHA_bypnltprs.png", width = 15, height=15, units="cm")

```

## relationship b/w penalty pressure & referral hhi
```{r}
test <- subset(df, pac=="SNF" & condition=="Heart Failure" )
table(test$fy)
test$std_pnltprs <- scale(test$pnltprs)

ggplot(test, aes(x=std_pnltprs, y=refhhi)) + facet_grid(fy~.) +
  geom_smooth() 

```







## Trend in VI by FY
HHA
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_VI_HHA_qtradj2.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")

# df$gp2 <- factor(df$gp, levels = c("pnlt_onlyhk15", "pnlt_hk15", "pnlt_nohk15"), labels=c("Penalized only for H/K", "Penalized for H/K", "Penalized for non H/K")) 

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' HHA referral concentration by condition",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hha_did2.png", width=15, height=10, units="cm")
```



## Trend in VI by quarters
HHA
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_VI_HHA_qtradj2.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")

# df$gp2 <- factor(df$gp, levels = c("pnlt_onlyhk15", "pnlt_hk15", "pnlt_nohk15"), labels=c("Penalized only for H/K", "Penalized for H/K", "Penalized for non H/K")) 

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' HHA referral concentration by condition",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hha_did2.png", width=15, height=10, units="cm")
```

SNF
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_VI_SNF_qtradj2.csv")

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")
summary(df)

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' SNF referral concentration by condition",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/snf_did2.png", width=15, height=10, units="cm")


# df$gp2 <- factor(df$gp, levels = c("pnlt_onlyhk15", "pnlt_hk15", "pnlt_nohk15"), labels=c("Penalized only for H/K", "Penalized for H/K", "Penalized for non H/K")) 

# ggplot(df, aes(fy, coef)) + facet_grid(.~gp2) +
#   geom_point(aes(shape=gp2), size=3, position=position_dodge(.9)) +
#   geom_line(position=position_dodge(.9)) +
#   geom_errorbar(aes(ymin = min95, ymax = max95), position=position_dodge(.9)) + 
#   geom_hline(aes(yintercept=0), linetype="dashed") + 
#   theme_bw() +
#   theme(legend.position="none") +
#   labs(title = "Trend in hospitals' SNF referral concentration for H/K patients by penalty status",
#        x="Year",
#        y="")
# ggsave("~/Dropbox/Research/VI/gph/snf_did.png")
```

## Trend in the share of referrals to PAC 
HHA
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_shref_HHA_qtradj.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")

# df$gp2 <- factor(df$gp, levels = c("pnlt_onlyhk15", "pnlt_hk15", "pnlt_nohk15"), labels=c("Penalized only for H/K", "Penalized for H/K", "Penalized for non H/K")) 

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' share of hospital discharges referred to HHA",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hha_did_shref.png", width=15, height=10, units="cm")
```

SNF
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_shref_SNF_qtradj.csv")

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")
summary(df)

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' share of hospital discharges referred to SNF",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/snf_did_shref.png", width=15, height=10, units="cm")
```


## By the readmission risk, how did the readmission rate & integration change over time? 
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_DiD_qtr_iv_adj.csv")
df <- subset(df, iv=="rblack")

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels= c("AMI", "HF", "PN", "HK"))
                  # labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))
# df$iv <- factor(df$iv, levels = c("rblack", "ses_score", "rreadmit90"), c("% Black", "SES score", "90-day readmission"))
df$iv <- factor(df$iv, levels = c("rblack"), c("% Black"))
df$y <- factor(df$y, levels = c("refhhi", "rread30p"), c("Referral concentration", "30-day PAC readmission rate"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")
summary(df)
```

### Using only the % blacks, 
```{r}
df2 <- subset(df, pac=="HHA" & y=="Referral concentration")

ggplot(df2, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on HHA referral concentration",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hha_impact_bytop3rd.png", width=15, height=15, units="cm")

df2 <- subset(df, pac=="SNF" & y=="Referral concentration")

ggplot(df2, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on SNF referral concentration",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/snf_impact_bytop3rd.png", width=15, height=15, units="cm")

```

### Using different predictors of initial risk penalty
HHA
```{r}
df2 <- subset(df, cond=="HK" & pac=="HHA")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to HHA",
       subtitle = "Hip/Knee",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hk_hha_impact_bytop3rd.png", width=15, height=15, units="cm")



df2 <- subset(df, cond=="AMI" & pac=="HHA")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to HHA",
       subtitle = "AMI",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/ami_hha_impact_bytop3rd.png", width=15, height=15, units="cm")


df2 <- subset(df, cond=="HF" & pac=="HHA")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to HHA",
       subtitle = "HF",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hf_hha_impact_bytop3rd.png", width=15, height=15, units="cm")


df2 <- subset(df, cond=="PN" & pac=="HHA")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to HHA",
       subtitle = "Pneumonia",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/pn_hha_impact_bytop3rd.png", width=15, height=15, units="cm")
```

SNF
```{r}
df2 <- subset(df, cond=="HK" & pac=="SNF")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "Hip/Knee",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hk_SNF_impact_bytop3rd.png", width=15, height=20, units="cm")



df2 <- subset(df, cond=="AMI" & pac=="SNF")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "AMI",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/ami_SNF_impact_bytop3rd.png", width=15, height=15, units="cm")


df2 <- subset(df, cond=="HF" & pac=="SNF")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "HF",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hf_SNF_impact_bytop3rd.png", width=15, height=15, units="cm")


df2 <- subset(df, cond=="PN" & pac=="SNF")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "Pneumonia",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/pn_SNF_impact_bytop3rd.png", width=15, height=15, units="cm")
```

## Do initial risk of factors predict the penalty ERRs?
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/penaltystatus_iv.csv")
df$top3rd_rblack <- factor(df$top3rd_rblack)
df$top3rd_rnonwhite <- factor(df$top3rd_rnonwhite)
df$top3rd_rread30 <- factor(df$top3rd_rread30)
df$top3rd_ses_score <- factor(df$top3rd_ses_score)

df$penalized <- factor(df$pnltr > 0)

df2 <- subset(df, err_!=0 & fy < 2017)

df2$fy <- factor(df2$fy)

# black is pretty much a linear predictor
ggplot(df2, aes(x=rblack, y=err_, colour=fy)) + facet_grid(.~condition) +
  geom_smooth()  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "Pneumonia",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/pn_SNF_impact_bytop3rd.png", width=15, height=15, units="cm")

ggplot(df2, aes(x=rblack, colour=fy, linetype=penalized)) + facet_grid(condition~.) +
  geom_density() +
theme_bw(base_size = 11) +
  theme(legend.position="bottom")

ggplot(df2, aes(x=rnonwhite, y=err_, colour=fy)) + facet_grid(condition~.) +
  geom_smooth()

ggplot(df2, aes(x=rread30, y=err_, colour=fy, linetype=penalized)) +
  geom_smooth()

ggplot(df2, aes(x=ses_score, y=err_, colour=fy, linetype=penalized)) +
  geom_smooth()

```

## Fiscal-year level analysis
H/K
```{r}
df  <- read.csv("/Users/kimk13/Dropbox/Research/VI/data/DIDest/coef_DiD_fy_pnltprs_hk.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df$est <- factor(df$est, labels = c("Top 3rd penalty pressure for H/K", "Rest"))

df2 <- subset(df, y=="refhhi")

ggplot(df2, aes(fy, coef, colour=est, linetype=est)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in hospitals' H/K referral concentration \nin top 3rd of penalty pressure compared to other penatly conditions",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhi.png", width=15, height=10, units="cm")


df2 <- subset(df, y=="refhhigr")

ggplot(df2, aes(fy, coef, colour=est, linetype=est)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in growth (%) of hospitals' H/K referral concentration \nin top 3rd of penalty pressure compared to other penatly conditions",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhigr.png", width=15, height=10, units="cm")
```

Other conditions (Ami, PN, HF)
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_DiD_fy_pnltprs_other.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df2 <- subset(df, y=="refhhi" & cond=="AMI")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in hospitals' AMI referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhi_AMI.png", width=15, height=10, units="cm")

df2 <- subset(df, y=="refhhi" & cond=="HF")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in hospitals' HF referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhi_HF.png", width=15, height=10, units="cm")

df2 <- subset(df, y=="refhhi" & cond=="PN")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in hospitals' PN referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhi_PN.png", width=15, height=10, units="cm")



df2 <- subset(df, y=="refhhigr" & cond=="AMI")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in growth (%) of hospitals' AMI referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhigr_AMI.png", width=15, height=10, units="cm")

df2 <- subset(df, y=="refhhigr" & cond=="HF")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in growth (%) of hospitals' HF referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhigr_HF.png", width=15, height=10, units="cm")

df2 <- subset(df, y=="refhhigr" & cond=="PN")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in growth (%) of hospitals' PN referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhigr_PN.png", width=15, height=10, units="cm")


```
