---
title: "DiD analysis of the impact of readmissions penalty on vertical integration"
author: "Lucy Kim"
date: "3/20/2018"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())

library(ggplot2)
library(zoo)
library(plyr)
source("~/Dropbox/Wharton/Research/Labor/code/summarySE.R")
```


# how good is our penalty pressure?

## *by 25th and 75th percentile penalty pressure hospitals, change in the actual penalty rate during 2013-2016
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/DIDest/pnltr_byhigh.csv")

df$high <- factor(df$qtl, levels = c(4,3,2,1), labels=c("Quartile 4 (Highest)", "Quartile 3", "Quartile 2", "Quartile 1 (Lowest)"))

df2 <- summarySE(df, measurevar=c("pnltr"), groupvars=c("high","fy"))

ggplot(df2) +
  geom_point(aes(x=fy, y=pnltr, shape=high, linetype=high), size=3) +
  geom_line(aes(x=fy, y=pnltr, shape=high, linetype=high)) + 
  geom_errorbar(aes(x=fy, ymin=pnltr-ci, ymax=pnltr+ci), width=0.1, alpha=0.8) +
  theme_bw(base_size=13) +
  labs(x="Year ending in June", y="",
       subtitle="Mean and 95% confidence intervals of the actual penalty rate (%)") +
  scale_y_continuous(limits = c(0,1.2),
                     breaks = seq(0,1.2,0.2),
                     minor_breaks = NULL) +
  scale_x_continuous(limits = c(2012.9,2018.1),
                     breaks= seq(2013,2018,1)) +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Expected penalty rate in the first year of HRRP", ncol=1),
         shape=guide_legend(title="Expected penalty rate in the first year of HRRP", ncol=1)) +
  scale_shape_manual(values = c(1,2,16,17))
ggsave("~/Dropbox/Research/VI/output/pnltr_byhigh.pdf", width = 15, height=10, units="cm")
ggsave("~/Dropbox/Research/VI/output/pnltr_byhigh.png", width = 15, height=10, units="cm")


# df$high <- factor(df$high, levels = c(1,0), labels=c("Top quartile (High)", "Bottom quartile (Low)"))
# df2 <- summarySE(df, measurevar=c("pnltr"), groupvars=c("high","fy"))
# ggplot(df2) +
#   geom_point(aes(x=fy, y=pnltr, shape=high, linetype=high), size=3) +
#   geom_line(aes(x=fy, y=pnltr, shape=high, linetype=high)) + 
#   geom_errorbar(aes(x=fy, ymin=pnltr-ci, ymax=pnltr+ci), width=0.1, alpha=0.8) +
#   theme_bw(base_size=13) +
#   labs(x="Year ending in June", y="",
#        subtitle="Mean and 95% confidence intervals of the actual penalty rate (%)") +
#   scale_y_continuous(limits = c(0,1.2),
#                      breaks = seq(0,1.2,0.2),
#                      minor_breaks = NULL) +
#   scale_x_continuous(limits = c(2012.9,2018.1),
#                      breaks= seq(2013,2018,1)) +
#   theme(legend.position="bottom", 
#         panel.grid.major.x = element_blank(),
#         panel.grid.minor.x = element_blank()) +
#   guides(linetype=guide_legend(title="Expected penalty rate for 2013", ncol=1),
#          shape=guide_legend(title="Expected penalty rate for 2013", ncol=1)) +
#   scale_shape_manual(values = c(17,1))
# ggsave("~/Dropbox/Research/VI/output/pnltr_byhigh.png", width = 15, height=10, units="cm")

```


## scatterplot of predicted penalty rate & actual penalty rate in t+2 (add correlation coefficient)
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/predict_pnltprs.csv")

df$provid <- factor(df$provid)

df[,c(2,4, 6:11)] <- 100*df[,c(2,4, 6:11)]

corr(df$pnltr2013, df$ppr)

# simple scatterplot of the predicted vs actual penalty rate
ggplot(df, aes(x=ppr, y=pnltr2013)) + 
  geom_point(shape = 1) + 
  # stat_smooth_func(geom="text",xpos = 2, ypos = 0.2,method="lm",hjust=0,parse=TRUE) +
  # geom_smooth(method="lm",se=FALSE) +
  geom_abline(aes(intercept=0, slope=1), alpha = 0.2) +
  labs(x="Expected penalty rate (%)", y="Actual penalty rate (%)") + 
  theme_bw(base_size = 20) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/ppr_realp.png", width =15, height=15, units="cm")

# simple density comparison
library(reshape2)
df2 <- melt(df, id.vars = c("provid"))    
df2 <- subset(df2, variable=="pnltr2013" | variable=="ppr")
df2$variable <- factor(df2$variable, labels = c("Actual penalty rate", "Expected penalty rate"))

ggplot(df2, aes(value)) + facet_grid(.~variable) +
  geom_histogram(bins=10) +
  # geom_density(aes(ppr), colour="black", linetype="dashed") +
  labs(x="Penalty rate (%)", y="Number of hospitals") +
  theme_bw(base_size = 20) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) 
ggsave("~/Dropbox/Research/VI/output/ppr_realp_hist.pdf", width =25, height=15, units="cm")
  
  
  
# simple scatterplot of the predicted vs actual penalty rate
ggplot(df, aes(x=ppst, y=penalized_t2)) + 
  geom_point(shape = 1) + 
  # stat_smooth_func(geom="text",xpos = 2, ypos = 0.2,method="lm",hjust=0,parse=TRUE) +
  # geom_smooth(method="lm",se=FALSE) +
  geom_abline(aes(intercept=0, slope=1), alpha = 0.2) +
  labs(x="Predicted likelihood of penalty", y="Penalized") + 
  theme_bw(base_size = 13) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

  

df2 <- subset(df, fy==2011)
df2$ppr11D <- cut(df2$ppr, breaks=c(quantile(df2$ppr, probs = seq(0, 1, by = 0.25), na.rm=TRUE)),
  labels=c("0-25","25-50","50-75","75-100"), include.lowest=TRUE)
df2$gp <- ifelse(df2$ppr11D=="75-100",1, ifelse(df2$ppr11D=="0-25",3,2))
df2$gp <- factor(df2$gp, levels=c(1,2,3), labels=c("High", "Medium", "Low"))
# 
# 
# df3 <- ddply(df2, .(ppr11D), summarise, m = mean(ppr))
# df2 <- merge(df2,df3, by="ppr11D", all.x=TRUE)
df2 <- df2[c("gp", "provid")]

df <- merge(df, df2, by="provid", all.x=TRUE)

df2 <- subset(df, fy >=2011)

lm_eqn <- function(df,y,x){
    m <- lm(y ~ x, df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(coef(m)[1], digits = 2), 
              b = format(coef(m)[2], digits = 2), 
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));                 
}

# p1 <- p + geom_text(x = 25, y = 300, label = lm_eqn(df), parse = TRUE)

library(devtools)
# devtools::source_gist("524eade46135f6348140", filename = "ggplot_smooth_func.R")

ggplot(df2, aes(x=ppr, y=realp)) + facet_wrap(~factor(fy)) +
  geom_point(shape = 1) + 
  # stat_smooth_func(geom="text",xpos = 2, ypos = 0.2,method="lm",hjust=0,parse=TRUE) +
  # geom_smooth(method="lm",se=FALSE) +
  geom_abline(aes(intercept=0, slope=1), alpha = 0.2) +
  labs(x="Predicted penalty rate (%)", y="Actual penalty rate (%)") + 
  theme_bw(base_size = 15) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
  ggsave("~/Dropbox/Research/VI/output/ppr_realp.png", width =22.75, height=12.5, units="cm")

  
library(reshape2)
df3 <- melt(df2, id.vars = c("provid", "fy"))    

ggplot(df3, aes(value, linetype=variable)) + facet_wrap(~factor(fy)) +
  geom_density() +
  # geom_density(aes(ppr), colour="black", linetype="dashed") +
  labs(x="Penalty rate (%)", y = "Density") +
  theme_bw(base_size = 15) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_linetype_discrete(name = "",
                        breaks= c("realp", "ppr"),
                        labels=c("Actual penalty rate", "Predicted penalty rate")) + 
  theme(legend.position="bottom")
  ggsave("~/Dropbox/Research/VI/output/ppr_realp_density.png", width =22.75, height=12.5, units="cm")
  
```



# Descriptive result: the mean outcomes across hospitals over time for hospitals in top and bottom third of penalty pressure

## For paper: all outcomes in a single graph 

 Mean outcome for top and bottom quatile of penalty pressure 
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/DIDest/trend_byquartile.csv")

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.3) # move them .05 to the left and right

table(df$gp)

df <- subset(df, gp=="shref_bytopSNF" | gp=="vi_snf" | gp=="qual_read" | gp=="read30_pac")

# multiply the readmission rate by 100 to make percentage
df$mean <- ifelse(df$gp=="read30_pac", 100*df$mean, df$mean)
df2 <- subset(df, gp=="read30_pac")
summary(df2)

df$gp <- factor(df$gp, levels=c("shref_bytopSNF","vi_snf","qual_read","read30_pac"), labels = c("Share of referrals to hospital's most referred SNF, %","Probability of acquiring SNF","Average SNF quality index","30-day readmission among patients referred to SNFs, %"))

df$year <- df$fy
df$high <- factor(df$high, levels = c(1,0), labels=c("Top quartile (High)", "Bottom quartile (Low)"))

# set manual scales using geom_blank: https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2
yrrange <- range(2009,2016)

range1 <- range(30,40)
range2 <- range(0,0.05)
range3 <- range(-0.2,0.03)
range4 <- range(15,35)

dummy1 <- data.frame(year = yrrange, mean=range1,
                     gp = "Share of referrals to hospital's most referred SNF, %", stringsAsFactors=TRUE)
dummy2 <- data.frame(year = yrrange, mean=range2,
                     gp = "Probability of acquiring SNF", stringsAsFactors=TRUE)
dummy3 <- data.frame(year = yrrange, mean=range3,
                     gp = "Average SNF quality index", stringsAsFactors=TRUE)
dummy4 <- data.frame(year = yrrange, mean=range4,
                     gp = "30-day readmission among patients referred to SNFs, %", stringsAsFactors=TRUE)

dummies <- rbind(dummy1,dummy2, dummy3, dummy4)

# all outcomes in one graph
ggplot(df, aes(x=year, y = mean)) + 
  facet_wrap(~gp, ncol=1, scale="free") +
  geom_point(aes( shape=high, linetype=high), size=2) +
  geom_line(aes(shape=high, linetype=high)) +
  geom_blank(data=dummies) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=12) +
  geom_vline(aes(xintercept=2011), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Penalty pressure"),
         shape=guide_legend(title="Penalty pressure")) +
  scale_shape_manual(values = c(17,1)) 
ggsave("~/Dropbox/Research/VI/output/desc_alloutc2.pdf", width = 13.5, height=18, units="cm")
```

## For presentation slides, each outcome separately 
```{r}
df2 <- subset(df, gp=="A. Discharges referred to SNF, %")
ggplot(df2) + 
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=5) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  scale_y_continuous(limits=c(15, 25),
                     breaks = seq(15,25,2),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=25) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean",
       subtitle="Share of discharges referred to SNF, %") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Expected penalty rate for 2013", ncol=1),
         shape=guide_legend(title="Expected penalty rate for 2013", ncol=1)) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/shref.png", width = 25, height=20, units="cm")

df2 <- subset(df, gp=="B. Average comorbidity count per SNF referred patient")
ggplot(df2) + 
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=5) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  scale_y_continuous(limits=c(0, .2),
                     breaks = seq(0,0.2,0.05),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=25) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean",
       subtitle="Average comorbidity counts per SNF referred patient") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Expected penalty rate for 2013", ncol=1),
         shape=guide_legend(title="Expected penalty rate for 2013", ncol=1)) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/comorbid.png", width = 25, height=20, units="cm")


df2 <- subset(df, gp=="C. Probability of acquiring SNF")
df2$mean <- 100*df2$mean
ggplot(df2) + 
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=5) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  scale_y_continuous(limits=c(0,5),
                     breaks = seq(0,5,1),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=25) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean",
       subtitle="Probability of acquiring a SNF given not having one \nat baseline, %") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Expected penalty rate for 2013", ncol=1),
         shape=guide_legend(title="Expected penalty rate for 2013", ncol=1)) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/vi_snf.png", width = 25, height=20, units="cm")

df$gp <- factor(df$gp, levels=c("shref","comorbidsum","vi_snf","refhhi3","shref_bytopSNF","reqSNF_80pct","qual_read"), labels = c("A. Discharges referred to SNF, %","B. Average comorbidity count per SNF referred patient","C. Probability of acquiring SNF","D. SNF referral HHI","E. Share of referrals to hospital's most referred SNF, %","F. Number of SNFs accounting for 80% of referrals","G. Average SNF performance at baseline"))
# "Share of AMI discharges referred to SNF","Share of HF discharges referred to SNF","Share of PN discharges referred to SNF","Share of HK discharges referred to SNF"


df2 <- subset(df, gp=="D. SNF referral HHI")
ggplot(df2) +   
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=5) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  scale_y_continuous(limits=c(0.15, .25),
                     breaks = seq(0.15,0.25,0.02),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=25) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean",
       subtitle="SNF referral HHI") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Expected penalty rate for 2013", ncol=1),
         shape=guide_legend(title="Expected penalty rate for 2013", ncol=1)) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/refhhi.png", width = 25, height=20, units="cm")

df2 <- subset(df, gp=="E. Share of referrals to hospital's most referred SNF, %")
ggplot(df2) +   
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=5) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  scale_y_continuous(limits=c(30, 40),
                     breaks = seq(30,40,2),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=25) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean",
       subtitle="Share of referrals to hospital's most referred SNF, %") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Expected penalty rate for 2013", ncol=1),
         shape=guide_legend(title="Expected penalty rate for 2013", ncol=1)) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/shref_bytopSNF.png", width = 25, height=20, units="cm")

df2 <- subset(df, gp=="F. Number of SNFs accounting for 80% of referrals")
ggplot(df2) +   
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=5) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  scale_y_continuous(limits=c(5, 8),
                     breaks = seq(5,8,1),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=25) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean",
       subtitle="Number of SNFs accounting for 80% of referrals") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Expected penalty rate for 2013", ncol=1),
         shape=guide_legend(title="Expected penalty rate for 2013", ncol=1)) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/nsnf_80pct.png", width = 25, height=20, units="cm")


df2 <- subset(df, gp=="Baseline performance of SNFs referred")
ggplot(df2) + 
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=5) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  scale_y_continuous(limits=c(3, 3.3),
                     breaks = seq(3,3.3,0.1),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=25) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean",
       subtitle="Baseline performance of SNFs referred") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Expected penalty rate for 2013", ncol=1),
         shape=guide_legend(title="Expected penalty rate for 2013", ncol=1)) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/qual_read.png", width = 25, height=20, units="cm")




df2 <- subset(df, gp=="Share of AMI discharges referred to SNF")
ggplot(df2) + 
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=3) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  scale_y_continuous(limits=c(0.1, .3),
                     breaks = seq(0.1,0.3,0.05),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=15) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_vline(aes(xintercept=2011.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Penalty pressure"),
         shape=guide_legend(title="Penalty pressure")) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/shrefAMI.pdf", width = 25, height=20, units="cm")

df2 <- subset(df, gp=="Share of HF discharges referred to SNF")
ggplot(df2) + 
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=3) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  # scale_y_continuous(limits=c(0.1, .3),
  #                    breaks = seq(0.1,0.3,0.1),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=15) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_vline(aes(xintercept=2011.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Penalty pressure"),
         shape=guide_legend(title="Penalty pressure")) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/shrefHF.pdf", width = 25, height=20, units="cm")


df2 <- subset(df, gp=="Share of PN discharges referred to SNF")
ggplot(df2) + 
  geom_point(aes(x=year, y = mean, shape=high, linetype=high), size=3) +
  geom_line(aes(x=year, y = mean, shape=high, linetype=high)) +
  # scale_y_continuous(limits=c(0.1, .3),
  #                    breaks = seq(0.1,0.3,0.1),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2009,2016,1)) +
  theme_bw(base_size=15) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_vline(aes(xintercept=2011.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Mean") +
  theme(legend.position="bottom", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Penalty pressure"),
         shape=guide_legend(title="Penalty pressure")) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/shrefPN.pdf", width = 25, height=20, units="cm")

```



# OLS Results: Import coefficient estimates & 95% confidence intervals from the diff-in-diff estimates with year dummies

Readmission 
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_DiD_static_reform.csv")

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.3) # move them .05 to the left and right

table(df$gp)
df$gp <- factor(df$gp, levels=c("read30_pac", "read30_other"), labels = c("Patients referred to SNF", "All other patients"))

# df$gp <- factor(df$gp, levels=c("read30","read30_pac","shref","vi_snf","refhhi3","shref_bytopSNF","lnreqSNF_80pct", "lnrefdensity"), labels = c("30-day readmission","30-day readmission after referred to SNF","Probability of referring to SNF","Acquisition of SNF","SNF referral HHI","Referral share by top referred SNF","Log # SNFs taking 80% referrals","Log SNF referral density"))

# # calculate the effect of increasing penalty rate from 0.12% (33rd percentile) to 0.32% (66th percentile) - have to multiply 95% CI's too
# df$estimate <- df$estimate * 0.2

# readmission
ggplot(df) +
  geom_point(aes(x=year, y = estimate, shape=gp), position=pd, size=3) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95, linetype=gp), width=.5, position=pd, alpha=0.8) +
  # scale_y_continuous(limits=c(-.105, .02),
  #                    breaks = seq(-0.1,0.02,0.02),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=15) +
  geom_hline(aes(yintercept=0), colour="black") +
  labs(x="Year ending in June",
       y="Change relative to 2009") +
  theme(legend.position="bottom", 
        legend.title=element_blank(),
        panel.grid.major.x = element_blank()) +
  scale_shape_manual(values = c(17,1))
ggsave("~/Dropbox/Research/VI/output/did_readmit.pdf", width = 15, height=10, units="cm")
```

All other referral outcomes
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_DiD_static_refoutc.csv")

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.3) # move them .05 to the left and right

table(df$gp) 
df$gp <- factor(df$gp, levels=c("shref_bytopSNF", "vi_snf", "qual_read", "refhhi3", "lnreqSNF_80pct", "shref","comorbidsum", "read30_pac", "read30_other"), labels = c( "A. Share of referrals to hospital's most referred SNF, %",  "B. Probability of acquiring SNF","C. Average SNF performance at baseline","D. SNF referral HHI", "E. Log Number of SNFs accounting for 80% of referrals", "F. Discharges referred to SNF, %","G. Average comorbidity count per SNF referred patient", "H. Readmission rate (%), patients referred to SNF", "I. Readmission rate (%), all other patients" ))
                                
# df$gp <- factor(df$gp, levels=c("shref","comorbidsum","vi_snf","refhhi3","shref_bytopSNF","lnreqSNF_80pct","qual_read","read30_pac", "read30_other"), labels = c("A. Discharges referred to SNF, %","B. Average comorbidity count per SNF referred patient","C. Probability of acquiring SNF","D. SNF referral HHI","E. Share of referrals to hospital's most referred SNF, %","F. Log Number of SNFs accounting for 80% of referrals","G. Average SNF performance at baseline", "H. Readmission rate (%), patients referred to SNF", "I. Readmission rate (%), all other patients"))

range <- range(-20,0)
yrrange2 <- range(2010, 2016)
dummy <- data.frame(year = yrrange2, mean=range,
                     gp = "I. Readmission rate (%), all other patients", stringsAsFactors=TRUE)
  
# all other outcomes in a single figure:  "Impact of increase in the predicted penalty rate from 25th to 75th percentile for 2013"
ggplot(df) + 
  # facet_wrap(~gp, ncol=2) +
  facet_wrap(~gp, ncol=2, scale="free") +
  geom_point(aes(x=year, y = estimate), size=2, shape=1) +
  geom_line(aes(x=year, y = estimate), alpha = 0.2) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  geom_blank(data=dummy, aes(x=year, y=mean)) +
  # scale_y_continuous(limits=c(-0.3, 0.3),
  #                    breaks = seq(-0.3,0.3,0.1)) +
  scale_x_continuous(breaks = seq(2010,2016,1)) +
  theme_bw(base_size=15) +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  geom_vline(aes(xintercept=2011), colour="black", alpha=0.5, linetype="dashed") +
  # geom_vline(aes(xintercept=2011.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Change relative to 2009") +
  theme(legend.position="bottom", 
        legend.title=element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/OLS_alloutc_reform2.png", width = 25, height=30, units="cm")
```



# IV Results: Import coefficient estimates & 95% confidence intervals from the diff-in-diff estimates
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/DIDest/IVcoef_DiD_static.csv")

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.3) # move them .05 to the left and right

table(df$gp)
df <- subset(df, gp!="lnreqSNF_80pct")
df$gp <- factor(df$gp, levels=c("read30","read30_pac","shref","vi_snf","refhhi","shref_bytopSNF","den_nsnf_used"), labels = c("A. 30-day readmission rate","B. 30-day readmission after referred to SNF","C. Share of discharges referred to SNF","D. Acquisition of SNF","E. SNF referral HHI","F. Referral share by top referred SNF","G. Ratio of # referred SNFs to # referrals"))
# df$gp <- factor(df$gp, levels=c("read30","read30_pac","vi_snf","refhhi","shref_bytopSNF"), labels = c("30-day readmission","30-day readmission after referred to SNF","Acquisition of SNF","SNF referral HHI","Referral share by top referred SNF"))

# all outcomes in a single figure:  "Impact of 1% increase in the predicted penalty rate for 2013"
ggplot(df) + facet_wrap(~gp, ncol=2) +
  geom_point(aes(x=year, y = estimate), size=2, shape=1) +
  geom_line(aes(x=year, y = estimate), alpha = 0.2) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  scale_y_continuous(limits=c(-.2, .2),
                     breaks = seq(-0.2,0.2,0.1),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = seq(2010,2016,1)) +
  theme_bw(base_size=13) +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_vline(aes(xintercept=2011.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Change relative to 2009") +
  theme(legend.position="bottom", 
        legend.title=element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/IV_alloutc.pdf", width = 16, height=15, units="cm")

# with reform
df <- read.csv("~/Dropbox/Research/VI/data/DIDest/IVcoef_DiD_static_reform_2iv.csv")

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.3) # move them .05 to the left and right

table(df$gp)
df <- subset(df, gp!="lnreqSNF_80pct")
df$gp <- factor(df$gp, levels=c("read30","read30_pac","shref","vi_snf","refhhi","shref_bytopSNF","den_nsnf_used"), labels = c("A. 30-day readmission rate","B. 30-day readmission after referred to SNF","A. Share of discharges referred to SNF","B. Acquisition of SNF","C. SNF referral HHI","D. Referral share by top referred SNF","E. Ratio of # referred SNFs to # referrals"))
# df$gp <- factor(df$gp, levels=c("read30","read30_pac","vi_snf","refhhi","shref_bytopSNF"), labels = c("30-day readmission","30-day readmission after referred to SNF","Acquisition of SNF","SNF referral HHI","Referral share by top referred SNF"))

df2 <- subset(df, gp!="A. 30-day readmission rate" & gp!="B. 30-day readmission after referred to SNF")
  
# all outcomes in a single figure:  "Impact of 1% increase in the predicted penalty rate for 2013"
ggplot(df2) + facet_wrap(~gp, ncol=2) +
  geom_point(aes(x=year, y = estimate), size=1.5, shape=1) +
  geom_line(aes(x=year, y = estimate), alpha = 0.2) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  scale_y_continuous(limits=c(-.15, .23),
                     breaks = seq(-0.1,0.2,0.1)) +
  scale_x_continuous(breaks = seq(2010,2016,2)) +
  theme_bw(base_size=13) +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_vline(aes(xintercept=2011.5), colour="black", alpha=0.5, linetype="dashed") +
  labs(x="Year ending in June",
       y="Change relative to 2009") +
  theme(legend.position="bottom", 
        legend.title=element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/IV_alloutc_reforms.pdf", width = 25, height=15, units="cm")


```


# Plot the coefficients on interaction between dynamic penalty pressure and year dummies
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_DiD_dynamic.csv")

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.3) # move them .05 to the left and right

# readmission
df2 <- subset(df, gp=="read30" | gp=="read30_pac")
df2$gp <- factor(df2$gp, labels = c("All patients", "Patients referred to SNF"))

ggplot(df2) +
  geom_point(aes(x=year, y = estimate, shape=gp), position=pd, size=3) +
  geom_line(aes(x=year, y = estimate, shape=gp), position=pd, alpha = 0.4) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95, linetype=gp), width=.1, position=pd, alpha=0.5) +
  # scale_y_continuous(limits=c(-.2, .05),
  #                    breaks = seq(-0.2,0.05,0.05),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=14) +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  labs(x="Year ending in June",
       y="", 
       subtitle="30-day hospital readmission rate") +
  theme(legend.position="bottom", 
        legend.title=element_blank(),
        panel.grid.major.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/readmit_dpp.pdf", width = 15, height=10, units="cm")

# probability of referring to SNF
df2 <- subset(df, gp=="shref_ddest")
ggplot(df2) +
  geom_point(aes(x=year, y = estimate), size=3) +
  geom_line(aes(x=year, y = estimate)) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  # scale_y_continuous(limits=c(-.05, .05),
  #                    breaks = seq(-0.05,0.05,0.025),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=14) +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  labs(x="Year ending in June",
       y="",
       subtitle="Probability of referring to SNF") +
  theme(panel.grid.major.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/shref_ddest_dpp.pdf", width = 15, height=10, units="cm")

df2 <- subset(df, gp=="shref")
ggplot(df2) +
  geom_point(aes(x=year, y = estimate), size=3) +
  geom_line(aes(x=year, y = estimate)) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  # scale_y_continuous(limits=c(-.05, .05),
  #                    breaks = seq(-0.05,0.05,0.025),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=14) +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  labs(x="Year ending in June",
       y="",
       subtitle="Probability of referring to SNF") +
  theme(panel.grid.major.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/shref_dpp.pdf", width = 15, height=10, units="cm")


# other integration outcome
df2 <- subset(df, gp=="refhhi")
ggplot(df2) +
  geom_point(aes(x=year, y = estimate), size=3) +
  geom_line(aes(x=year, y = estimate)) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  # scale_y_continuous(limits=c(-.05, .05),
  #                    breaks = seq(-0.05,0.05,0.025),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=14) +
  # geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  labs(x="Year ending in June",
       y="",
       subtitle="SNF referral concentration") +
  theme(panel.grid.major.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/refhhi_dpp.pdf", width = 15, height=10, units="cm")

df2 <- subset(df, gp=="lnreqSNF_80pct")
ggplot(df2) +
  geom_point(aes(x=year, y = estimate), size=3) +
  geom_line(aes(x=year, y = estimate)) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  # scale_y_continuous(limits=c(-.1, .15),
  #                    breaks = seq(-0.1,0.15,0.05),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=14) +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  labs(x="Year ending in June",
       y="",
       subtitle="Log Number of SNFs required to serve 80% of SNF referrals") +
  theme(panel.grid.major.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/lnreqSNF_80pct_dpp.pdf", width = 15, height=10, units="cm")

df2 <- subset(df, gp=="shref_bytopSNF")
ggplot(df2) +
  geom_point(aes(x=year, y = estimate), size=3) +
  geom_line(aes(x=year, y = estimate)) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  scale_y_continuous(limits=c(-.05, .05),
                     breaks = seq(-0.05,0.05,0.025),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=14) +
  # geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  labs(x="Year ending in June",
       y="",
       subtitle="Share of referrals by the most referred SNF") +
  theme(panel.grid.major.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/shref_bytopSNF_dpp.pdf", width = 15, height=10, units="cm")

df2 <- subset(df, gp=="den_nsnf_used")
ggplot(df2) +
  geom_point(aes(x=year, y = estimate), size=3) +
  geom_line(aes(x=year, y = estimate)) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  # scale_y_continuous(limits=c(-.02, .06),
  #                    breaks = seq(-.02, .06,0.02),
  #                    minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=14) +
  # geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  labs(x="Year ending in June",
       y="",
       subtitle="Number of SNFs referred to per referral") +
  theme(panel.grid.major.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/den_nsnf_used_dpp.pdf", width = 15, height=10, units="cm")

df2 <- subset(df, gp=="vi_snf")
ggplot(df2) +
  geom_point(aes(x=year, y = estimate), size=3) +
  geom_line(aes(x=year, y = estimate)) +
  geom_errorbar(aes(x=year, ymin=min95, ymax=max95), width=.1, alpha=0.5) +
  scale_y_continuous(limits=c(-.04, 0.04),
                     breaks = seq(-.04, .08,0.02),
                     minor_breaks = NULL) +
  scale_x_continuous(breaks = c(2010:2016),
                     minor_breaks = NULL) +
  theme_bw(base_size=14) +
  # geom_vline(aes(xintercept=2010.5), colour="black", alpha=0.5, linetype="dashed") +
  geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
  labs(x="Year ending in June",
       y="",
       subtitle="Probability of acquiring a SNF") +
  theme(panel.grid.major.x = element_blank())
ggsave("~/Dropbox/Research/VI/output/vi_snf_dpp.pdf", width = 15, height=10, units="cm")
```


# pure trend in outcomes over time
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/trend.csv")

# provid fy read30 read30_pac refhhi shref_bytopSNF lnreqSNF_80pct gini den_nsnf_used

df2 <- summarySE(df, measurevar=c("shref"), groupvars=c("fy"))
ggplot(df2, aes(x=fy, y=shref)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin=shref-ci, ymax=shref+ci), width=.1) +
  theme_bw(base_size=14) +
  labs(x="Year ending in June", y="",
       subtitle="Probability of referring to SNF") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limits = c(0.1,0.3),
                     breaks = seq(0.1,0.3,0.1)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/trend_shref.pdf", width = 15, height=10, units="cm")


df2 <- summarySE(df, measurevar=c("refhhi"), groupvars=c("fy"))
ggplot(df2, aes(x=fy, y=refhhi)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin=refhhi-ci, ymax=refhhi+ci), width=.1) +
  theme_bw(base_size=14) +
  labs(x="Year ending in June", y="",
       subtitle="SNF referral concentration") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limits = c(0.18,0.22),
                     breaks = seq(0.18,0.22,0.01)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/trend_refhhi.pdf", width = 15, height=10, units="cm")

df2 <- summarySE(df, measurevar=c("shref"), groupvars=c("fy"))
ggplot(df2, aes(x=fy, y=shref)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin=shref-ci, ymax=shref+ci), width=.1) +
  theme_bw(base_size=14) +
  labs(x="Year ending in June", y="",
       subtitle="Probability of referring to SNF") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limits = c(0.1,0.3),
                     breaks = seq(0.1,0.3,0.1)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/trend_shref.pdf", width = 15, height=10, units="cm")

df2 <- summarySE(df, measurevar=c("den_nsnf_used"), groupvars=c("fy"))
ggplot(df2, aes(x=fy, y=den_nsnf_used)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin=den_nsnf_used-ci, ymax=den_nsnf_used+ci), width=.1) +
  theme_bw(base_size=14) +
  labs(x="Year ending in June", y="",
       subtitle="Number of SNF referred to per referral") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limits = c(0.1,0.3),
                     breaks = seq(0.1,0.3,0.1)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/trend_den_nsnf_used.pdf", width = 15, height=10, units="cm")

df2 <- summarySE(df, measurevar=c("shref_bytopSNF"), groupvars=c("fy"))
ggplot(df2, aes(x=fy, y=shref_bytopSNF)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin=shref_bytopSNF-ci, ymax=shref_bytopSNF+ci), width=.1) +
  theme_bw(base_size=14) +
  labs(x="Year ending in June", y="",
       subtitle="Share of SNF referrals by the most referred SNF") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limits = c(0.2,0.4),
                     breaks = seq(0.2,0.4,0.1)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/trend_shref_bytopSNF.pdf", width = 15, height=10, units="cm")


df2 <- summarySE(df, measurevar=c("vi_snf"), groupvars=c("fy"))
ggplot(df2, aes(x=fy, y=vi_snf)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), width=.1) +
  theme_bw(base_size=14) +
  labs(x="Year ending in June", y="",
       subtitle="Probability of having a hospital-based SNF") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limits = c(0.1,0.3),
                     breaks = seq(0.1,0.3,0.1)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/trend_vi_snf.pdf", width = 15, height=10, units="cm")

df2 <- subset(df, vi_snf2008==0)
df2 <- summarySE(df2, measurevar=c("vi_snf"), groupvars=c("fy"))
ggplot(df2, aes(x=fy, y=vi_snf)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), width=.1) +
  theme_bw(base_size=14) +
  labs(x="Year ending in June", y="",
       subtitle="Probability of acquiring a SNF given not having one in 2008") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limits = c(0,0.04),
                     breaks = seq(0,0.04,0.02)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/trend_vi_snf_adopt.pdf", width = 15, height=10, units="cm")


df2 <- summarySE(df, measurevar=c("read30"), groupvars=c("fy"))
df2$gp <- "read30"
df3 <- summarySE(df, measurevar=c("read30_pac"), groupvars=c("fy"))
df3$gp <- "read30_pac"
colnames(df2)[3] <- "value"
colnames(df3)[3] <- "value"
df4 <- rbind(df2, df3)

df4$gp <- factor(df4$gp, labels = c("All patients", "Patients referred to SNF"))

ggplot(df4) +
  geom_point(aes(x=fy, y=value, shape=gp), size=3) +
  geom_line(aes(x=fy, y=value, linetype=gp)) +
  geom_errorbar(aes(x=fy, ymin=value-ci, ymax=value+ci, group=gp), width=.1, alpha=0.5) +
  theme_bw(base_size=14) +
  labs(x="Year ending in June", y="",
       subtitle="Probability of referring to SNF") +
  theme(legend.position="bottom", 
        legend.title=element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limits = c(0.1,0.3),
                     breaks = seq(0.1,0.3,0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/trend_read.pdf", width = 15, height=10, units="cm")


```


# IV trend
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/iv.csv")

df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("High", "Medium", "Low"))
df$rblack <- 100*df$rblack

df2 <- df


ggplot(df2, aes(x=fy, y=ses_score, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="FY") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  # scale_y_continuous(limits = c(0,0.25),
                     # breaks = seq(0,0.25,0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 

```


# Outcome trend visualization

## time-constant penalty pressure
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/yv_mean_se.csv")

# df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("Top quartile", "Middle 2 quartiles", "Bottom quartile"))
df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("High", "Medium", "Low"))

df2 <- subset(df, cond=="Initial")

dl <- c("30-day", "31-60 day", "61-90 day")
yl <- c("hospital readmission rate", "hospital readmission rate among patients referred to SNF","same hospital return rate among patients referred to SNF")

i <- 0
for (n in seq(30,90,30)) {
  i <- i + 1
  j <- 0
  for (yy in c("read","pread","psamh")) {
    j <- j + 1
    yv <- paste0(yy,n)
    print(yv)
    ll <- paste0(dl[i], " ", yl[j])
    print(ll)
    
    ggplot(df2, aes_string(x="fy", y=yv, linetype="gp")) +
      geom_point(aes(shape=gp),size=2) +
      geom_line() + 
      theme_bw(base_size=13) +
      labs(x="Year", y="",
           subtitle=ll) +
      theme(legend.position="bottom",
            panel.grid.major.x = element_blank(),
            panel.grid.minor.x = element_blank()) +
      guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
             shape=guide_legend(title="Predicted penalty rate in 2011" )) +
      scale_y_continuous(limits = c(0,0.35),
                         breaks = seq(0,0.4,0.1)) +
      scale_x_continuous(limits = c(2008.5,2016.5),
                         breaks= seq(2009,2016,1))
    file <- paste0("~/Dropbox/Research/VI/output/des_",yv,"_bypp.png")
    ggsave(file, width = 15, height=10, units="cm")
  }
}


ggplot(df2, aes(x=fy, y=gini, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Gini coefficient of SNF referral") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(0.25,0.75)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_gini_bypp.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=vi_snf, linetype=gp)) +
  # geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), 
  #               width=.1,
  #               alpha=0.5,
  #               position=position_dodge(width=0.5)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Share of hospitals that formally own SNF") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(0,0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_vi_snf_bypp.png", width = 15, height=10, units="cm")

ggplot(df, aes(x=fy, y=dischnum, linetype=gp)) + facet_grid(.~cond) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of hospital discharges") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  # scale_y_continuous(limits = c(0.15,0.25),
  #                    breaks = seq(0.15,0.25, 0.02)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 

ggplot(df, aes(x=fy, y=dischnum_pac, linetype=gp)) + facet_grid(.~cond) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of hospital discharges referred to SNF") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  # scale_y_continuous(limits = c(0.15,0.25),
  #                    breaks = seq(0.15,0.25, 0.02)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 


ggplot(df, aes(x=fy, y=shref, linetype=gp)) + facet_grid(.~cond) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Share of hospital discharges referred to SNF") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  # scale_y_continuous(limits = c(0.15,0.25),
  #                    breaks = seq(0.15,0.25, 0.02)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_shref_bypp.png", width = 15, height=10, units="cm")

ggplot(df2, aes(x=fy, y=ppr, linetype=gp)) + facet_grid(.~cond) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="SNF referral concentration") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  # scale_y_continuous(limits = c(0.15,0.25),
                     # breaks = seq(0.15,0.25, 0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 


ggplot(df, aes(x=fy, y=refhhi, linetype=gp)) + facet_grid(.~cond) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="SNF referral concentration") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  # scale_y_continuous(limits = c(0.15,0.25),
                     # breaks = seq(0.15,0.25, 0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_refhhi_bypp.png", width = 15, height=10, units="cm")


ggplot(df, aes(x=fy, y=den_nsnf_used, linetype=gp)) + facet_grid(.~cond) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Ratio of the number of SNFs being referred to to number referral") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  # scale_y_continuous(limits = c(4,5),
  #                    breaks = seq(4,5,0.2)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_ln_den_nsnf_used_pp_bypp.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=den_nsnf_used_pp, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of SNFs being referred to / Probability of referral") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(70,100)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_den_nsnf_used_pp_bypp.png", width = 15, height=10, units="cm")

ggplot(df2, aes(x=fy, y=nsnf_used, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of SNFs being referred to") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(12,20),
                     breaks=seq(10,20,2)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_nsnf_used_bypp.png", width = 15, height=10, units="cm")
```


using data without June in each year
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/yv_mean_se_nojune.csv")

# df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("Top quartile", "Middle 2 quartiles", "Bottom quartile"))
df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("High", "Medium", "Low"))

colnames(df)[12:14] <- c("pread30","pread60","pread90")
colnames(df)[15:17] <- c("psamh30","psamh60","psamh90")

df2 <- df

dl <- c("30-day", "31-60 day", "61-90 day")
yl <- c("hospital readmission rate", "hospital readmission rate among patients referred to SNF","same hospital return rate among patients referred to SNF")

i <- 0
for (n in seq(30,90,30)) {
  i <- i + 1
  j <- 0
  for (yy in c("read","pread","psamh")) {
    j <- j + 1
    yv <- paste0(yy,n)
    print(yv)
    ll <- paste0(dl[i], " ", yl[j])
    print(ll)
    
    ggplot(df2, aes_string(x="fy", y=yv, linetype="gp")) +
      geom_point(aes(shape=gp),size=2) +
      geom_line() + 
      theme_bw(base_size=13) +
      labs(x="Year", y="",
           subtitle=ll) +
      theme(legend.position="bottom",
            panel.grid.major.x = element_blank(),
            panel.grid.minor.x = element_blank()) +
      guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
             shape=guide_legend(title="Predicted penalty rate in 2011" )) +
      # scale_y_continuous(limits = c(0,0.35),
      #                    breaks = seq(0,0.4,0.1)) +
      scale_x_continuous(limits = c(2008.5,2016.5),
                         breaks= seq(2009,2016,1))
    file <- paste0("~/Dropbox/Research/VI/output/des_",yv,"_bypp_nj.png")
    ggsave(file, width = 15, height=10, units="cm")
  }
}

ggplot(df2, aes(x=fy, y=vi_snf, linetype=gp)) +
  # geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), 
  #               width=.1,
  #               alpha=0.5,
  #               position=position_dodge(width=0.5)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Share of hospitals that formally own SNF") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(0,0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_vi_snf_bypp_nj.png", width = 15, height=10, units="cm")

ggplot(df2, aes(x=fy, y=shref, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Share of hospital discharges referred to SNF (No June)") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(0.15,0.25),
                     breaks = seq(0.15,0.25, 0.02)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_shref_bypp_nj.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=refhhi, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="SNF referral concentration (No June)") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(0.15,0.25),
                     breaks = seq(0.15,0.25, 0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_refhhi_bypp_nj.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=ln_den_nsnf_used_pp, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Log Number of SNFs being referred to / Probability of referral") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(4,5),
                     breaks = seq(4,5,0.2)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_ln_den_nsnf_used_pp_bypp_nj.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=den_nsnf_used_pp, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of SNFs being referred to / Probability of referral (No June)") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(70,100)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_den_nsnf_used_pp_bypp_nj.png", width = 15, height=10, units="cm")

ggplot(df2, aes(x=fy, y=nsnf_used, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of SNFs being referred to (No June)") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(12,20),
                     breaks=seq(10,20,2)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_nsnf_used_bypp_nj.png", width = 15, height=10, units="cm")
```



## time-varying penalty pressure
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/yv_mean_se_ts.csv") # already show aggregate mean
# df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("Top quartile", "Middle 2 quartiles", "Bottom quartile"))
df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("High", "Medium", "Low"))
table(df$fy, df$gp)

colnames(df)[12:14] <- c("pread30","pread60","pread90")
colnames(df)[15:17] <- c("psamh30","psamh60","psamh90")

df2 <- df

dl <- c("30-day", "31-60 day", "61-90 day")
yl <- c("hospital readmission rate", "hospital readmission rate among patients referred to SNF","same hospital return rate among patients referred to SNF")

i <- 0
for (n in seq(30,90,30)) {
  i <- i + 1
  j <- 0
  for (yy in c("read","pread","psamh")) {
    j <- j + 1
    yv <- paste0(yy,n)
    print(yv)
    ll <- paste0(dl[i], " ", yl[j])
    print(ll)
    
    ggplot(df2, aes_string(x="fy", y=yv, linetype="gp")) +
      geom_point(aes(shape=gp),size=2) +
      geom_line() + 
      theme_bw(base_size=13) +
      labs(x="Year", y="",
           subtitle=ll) +
      theme(legend.position="bottom",
            panel.grid.major.x = element_blank(),
            panel.grid.minor.x = element_blank()) +
      guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
             shape=guide_legend(title="Predicted penalty rate in each year" )) +
      scale_y_continuous(limits = c(0,0.35),
                         breaks = seq(0,0.4,0.1)) +
      scale_x_continuous(limits = c(2008.5,2016.5),
                         breaks= seq(2009,2016,1))
    file <- paste0("~/Dropbox/Research/VI/output/des_",yv,"_bypp_ts.png")
    ggsave(file, width = 15, height=10, units="cm")
  }
}

ggplot(df2, aes(x=fy, y=gini, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Gini coefficient of SNF referral") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(0.4,0.6)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_gini_bypp_ts.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=den_nsnf_used_pp, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of SNFs being referred to / Probability of referral") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(70,100)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_den_nsnf_used_pp_bypp_ts.png", width = 15, height=10, units="cm")

ggplot(df2, aes(x=fy, y=nsnf_used, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of SNFs being referred to") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(12,20),
                     breaks=seq(10,20,2)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_nsnf_used_bypp_ts.png", width = 15, height=10, units="cm")

ggplot(df2, aes(x=fy, y=shref, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Share of hospital discharges referred to SNF") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(0.15,0.25),
                     breaks = seq(0.15,0.25, 0.02)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_shref_bypp_ts.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=refhhi, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="SNF referral concentration") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(0.15,0.25),
                     breaks = seq(0.15,0.25, 0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_refhhi_bypp_ts.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=vi_snf, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Share of hospitals that formally own SNF") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(0,0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_vi_snf_bypp_ts.png", width = 15, height=10, units="cm")

```

using dynamic pressure data with no june
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/yv_mean_se_ts_nojune.csv") # already show aggregate mean
# df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("Top quartile", "Middle 2 quartiles", "Bottom quartile"))
df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("High", "Medium", "Low"))
table(df$fy, df$gp)

colnames(df)[12:14] <- c("pread30","pread60","pread90")
colnames(df)[15:17] <- c("psamh30","psamh60","psamh90")

df2 <- df

dl <- c("30-day", "31-60 day", "61-90 day")
yl <- c("hospital readmission rate", "hospital readmission rate among patients referred to SNF","same hospital return rate among patients referred to SNF")

i <- 0
for (n in seq(30,90,30)) {
  i <- i + 1
  j <- 0
  for (yy in c("read","pread","psamh")) {
    j <- j + 1
    yv <- paste0(yy,n)
    print(yv)
    ll <- paste0(dl[i], " ", yl[j])
    print(ll)
    
    ggplot(df2, aes_string(x="fy", y=yv, linetype="gp")) +
      geom_point(aes(shape=gp),size=2) +
      geom_line() + 
      theme_bw(base_size=13) +
      labs(x="Year", y="",
           subtitle=ll) +
      theme(legend.position="bottom",
            panel.grid.major.x = element_blank(),
            panel.grid.minor.x = element_blank()) +
      guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
             shape=guide_legend(title="Predicted penalty rate in each year" )) +
      # scale_y_continuous(limits = c(0,0.35),
      #                    breaks = seq(0,0.4,0.1)) +
      scale_x_continuous(limits = c(2008.5,2016.5),
                         breaks= seq(2009,2016,1))
    file <- paste0("~/Dropbox/Research/VI/output/des_",yv,"_bypp_ts_nj.png")
    ggsave(file, width = 15, height=10, units="cm")
  }
}


ggplot(df2, aes(x=fy, y=den_nsnf_used_pp, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of SNFs being referred to / Probability of referral") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  # scale_y_continuous(limits = c(100,145)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_den_nsnf_used_pp_bypp_ts_nj.png", width = 15, height=10, units="cm")

ggplot(df2, aes(x=fy, y=nsnf_used, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Number of SNFs being referred to") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(14,20),
                     breaks=seq(10,20,2)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_nsnf_used_bypp_ts_nj.png", width = 15, height=10, units="cm")

ggplot(df2, aes(x=fy, y=shref, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Share of hospital discharges referred to SNF") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(0.1,0.25),
                     breaks = seq(0.1,0.25, 0.02)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_shref_bypp_ts_nj.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=refhhi, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="SNF referral concentration") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(0.15,0.25),
                     breaks = seq(0.15,0.25, 0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_refhhi_bypp_ts_nj.png", width = 15, height=10, units="cm")


ggplot(df2, aes(x=fy, y=vi_snf, linetype=gp)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Share of hospitals that formally own SNF") +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in each year"),
         shape=guide_legend(title="Predicted penalty rate in each year" )) +
  scale_y_continuous(limits = c(0,0.05)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/des_vi_snf_bypp_ts_nj.png", width = 15, height=10, units="cm")

```


# the volatility of penalty pressure over time: is there big shuffling of hospitals in the high-penalty group?
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/ppr_vs_realp_byfy2.csv")

df$provid <- factor(df$provid)

df2 <- subset(df, fy==2011)
df2$ppr11D <- cut(df2$ppr, breaks=c(quantile(df2$ppr, probs = seq(0, 1, by = 0.25), na.rm=TRUE)),
  labels=c("0-25","25-50","50-75","75-100"), include.lowest=TRUE)
df2$gp <- ifelse(df2$ppr11D=="75-100",1, ifelse(df2$ppr11D=="0-25",3,2))
df2$gp <- factor(df2$gp, levels=c(1,2,3), labels=c("High", "Medium", "Low"))
# 
# 
# df3 <- ddply(df2, .(ppr11D), summarise, m = mean(ppr))
# df2 <- merge(df2,df3, by="ppr11D", all.x=TRUE)
df2 <- df2[c("gp", "provid")]

df <- merge(df, df2, by="provid", all.x=TRUE)

d1 <- summarySE(df, measurevar=c("ppr"), groupvars=c("fy","gp"))
ggplot(d1, aes(x=fy, y=ppr, colour=gp)) + 
  geom_line()


d2 <- summarySE(df, measurevar=c("realp"), groupvars=c("fy","gp"))
ggplot(d2, aes(x=fy, y=realp, colour=gp)) + 
  geom_line()

ggplot(df, aes(x=ppr)) + facet_grid(.~factor(fy)) +
  geom_density()


library(tidyr)
df.w <- spread(df[c("fy","ppr","provid")], key = fy, value = ppr)
colnames(df.w)[4:9] <- paste0("ppr",colnames(df.w)[4:9])


ggplot(df.w, aes(x=ppr2011,y=ppr2012)) +
  geom_point() +
  geom_abline(slope=1, intercept=0)

df.w$d_12_11 <- df.w$ppr2012 - df.w$ppr2011
ggplot(df.w, aes(x=d_12_11)) +
  geom_histogram()

ggplot(df.w, aes(d_12_11)) + 
  stat_ecdf(geom = "step") + 
  labs(x="Predicted penalty rate in 2012 - Predicted penalty rate in 2011", y = "Cumulative fraction of hospitals") +
  theme_bw(base_size =12) + 
  scale_y_continuous(breaks=seq(0,1,0.2)) + 
  scale_x_continuous(limits = c(-2,2),                      
                     breaks=seq(-2,2,0.5)) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_vline(xintercept=0, linetype="dashed")
ggsave("~/Dropbox/Research/VI/output/d_12_11.png", width = 15, height=10, units="cm")

df.w$d_13_12 <- df.w$ppr2013 - df.w$ppr2012
ggplot(df.w, aes(d_13_12)) + 
  stat_ecdf(geom = "step") + 
  labs(x="Predicted penalty rate in 2013 - Predicted penalty rate in 2012", y = "Cumulative fraction of hospitals") +
  theme_bw(base_size =12) + 
  scale_y_continuous(breaks=seq(0,1,0.2)) + 
  scale_x_continuous(limits = c(-2,2),                     
                     breaks=seq(-2,2,0.5)) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_vline(xintercept=0, linetype="dashed")
ggsave("~/Dropbox/Research/VI/output/d_13_12.png", width = 15, height=10, units="cm")

df.w$d_14_13 <- df.w$ppr2014 - df.w$ppr2013
ggplot(df.w, aes(d_14_13)) + 
  stat_ecdf(geom = "step") + 
  labs(x="Predicted penalty rate in 2014 - Predicted penalty rate in 2013", y = "Cumulative fraction of hospitals") +
  theme_bw(base_size =12) + 
  scale_y_continuous(breaks=seq(0,1,0.2)) + 
  scale_x_continuous(limits = c(-2,2),                     
                     breaks=seq(-2,2,0.5)) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_vline(xintercept=0, linetype="dashed")
ggsave("~/Dropbox/Research/VI/output/d_14_13.png", width = 15, height=10, units="cm")


df.w$d_15_14 <- df.w$ppr2015 - df.w$ppr2014
ggplot(df.w, aes(d_15_14)) + 
  stat_ecdf(geom = "step") + 
  labs(x="Predicted penalty rate in 2015 - Predicted penalty rate in 2014", y = "Cumulative fraction of hospitals") +
  theme_bw(base_size =12) + 
  scale_y_continuous(breaks=seq(0,1,0.2)) + 
  scale_x_continuous(limits = c(-2,2),
                     breaks=seq(-2,2,0.5)) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_vline(xintercept=0, linetype="dashed") 
ggsave("~/Dropbox/Research/VI/output/d_15_14.png", width = 15, height=10, units="cm")

df.w$d_16_15 <- df.w$ppr2016 - df.w$ppr2015
ggplot(df.w, aes(d_16_15)) + 
  stat_ecdf(geom = "step") + 
  labs(x="Predicted penalty rate in 2016 - Predicted penalty rate in 2015", y = "Cumulative fraction of hospitals") +
  theme_bw(base_size =12) + 
  scale_y_continuous(breaks=seq(0,1,0.2)) + 
  scale_x_continuous(limits = c(-2,2),
                     breaks=seq(-2,2,0.5)) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_vline(xintercept=0, linetype="dashed") 
ggsave("~/Dropbox/Research/VI/output/d_16_15.png", width = 15, height=10, units="cm")


```

# difference between time-constant and time-varying penalty pressure

## 2011 penalty group
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/diff_ppr.csv")

df$gp <- df$gp2011
# df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("Top quartile", "Middle 2 quartiles", "Bottom quartile"))
df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("High", "Medium", "Low"))

df$ppr <- df$diff_ppr2011 + df$ppr2011

df2 <- summarySE(df, measurevar="ppr", groupvars=c("fy","gp"))
ggplot(df2, aes(x=fy, y=ppr, linetype=gp)) +
  # geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), 
  #               width=.1,
  #               alpha=0.5,
  #               position=position_dodge(width=0.5)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Mean predicted penalty rate in each year [%]" ) +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(0,1.2),
                     breaks = seq(0,1.2,0.2)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/ppr_bypp2011.png", width = 15, height=10, units="cm")


df2 <- summarySE(df, measurevar="pnltrate_t2", groupvars=c("fy","gp"))
ggplot(df2, aes(x=fy, y=pnltrate_t2, linetype=gp)) +
  # geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), 
  #               width=.1,
  #               alpha=0.5,
  #               position=position_dodge(width=0.5)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="Mean actual penalty rate in each year [%]" ) +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(0,1.2),
                     breaks = seq(0,1.2,0.2)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/pnltrate_t2_bypp2011.png", width = 15, height=10, units="cm")

#if you were top quartile of predicted penalty rate in each year 2011 - later, what was your predicted penalty rate in the previous and after then?


yv <- c("diff_ppr2011")
df2 <- summarySE(df, measurevar="diff_ppr2011", groupvars=c("fy","gp"))
ggplot(df2, aes(x=fy, y=diff_ppr2011, linetype=gp)) +
  # geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), 
  #               width=.1,
  #               alpha=0.5,
  #               position=position_dodge(width=0.5)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="(Predicted penalty rate in each year) - (Predicted penalty rate in 2011) [%]" ) +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(-1,1)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/diff_ppr2011.png", width = 15, height=10, units="cm")


yv <- c("diff_ppr2012")
df2 <- summarySE(df, measurevar="diff_ppr2012", groupvars=c("fy","gp"))
ggplot(df2, aes(x=fy, y=diff_ppr2012, linetype=gp)) +
  # geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), 
  #               width=.1,
  #               alpha=0.5,
  #               position=position_dodge(width=0.5)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="(Predicted penalty rate in each year) - (Predicted penalty rate in 2012) [%]" ) +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(-1,1)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/diff_ppr2012_bypp2011.png", width = 15, height=10, units="cm")
```

## 2012 penalty group
```{r}
df$gp <- df$gp2012
df$gp <- factor(df$gp, levels=c(1,2,3), labels=c("Top quartile", "Middle 2 quartiles", "Bottom quartile"))

yv <- c("diff_ppr2012")
df2 <- summarySE(df, measurevar="diff_ppr2012", groupvars=c("fy","gp"))
ggplot(df2, aes(x=fy, y=diff_ppr2012, linetype=gp)) +
  # geom_errorbar(aes(ymin=vi_snf-ci, ymax=vi_snf+ci), 
  #               width=.1,
  #               alpha=0.5,
  #               position=position_dodge(width=0.5)) +
  geom_point(aes(shape=gp),size=2) +
  geom_line() + 
  theme_bw(base_size=13) +
  labs(x="Year", y="",
       subtitle="(Predicted penalty rate in each year) - (Predicted penalty rate in 2012) [%]" ) +
  theme(legend.position="bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(linetype=guide_legend(title="Predicted penalty rate in 2011"),
         shape=guide_legend(title="Predicted penalty rate in 2011" )) +
  scale_y_continuous(limits = c(-1,1)) +
  scale_x_continuous(limits = c(2008.5,2016.5),
                     breaks= seq(2009,2016,1)) 
ggsave("~/Dropbox/Research/VI/output/diff_ppr2012_bypp2012.png", width = 15, height=10, units="cm")

```


# Import coefficient estimates & 95% confidence intervals from the diff-in-diff estimation
```{r}
df <- read.csv("~/Dropbox/Research/VI/output/est_pp2012.csv")

```


```{r}
# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.3) # move them .05 to the left and right

pv <- c("ppst2012","ppr2012","lppd2012")  

outc <- c("shref")
outclab <- c("Share of discharges referred to SNF")
iy <- 0  
for (y in outc) {
  iy <- iy + 1
  ix <- 0
  
  for (x in pv) {
    ix <- ix + 1
    
    # plot the high & medium penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp !="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.05, .05),
                         breaks = seq(-0.05,0.05,0.01),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016),
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June",
           y="Change relative to 2009 and \nto low-penalty pressure hospitals",
                      title=outclab[iy],
           subtitle=plab[ix]) +
      scale_linetype_manual(values=c(1,2), name="", labels=c("Middle 2 quartiles",   "Top quartlie")) +
      scale_shape_discrete(name="", label=c("Middle 2 quartiles", "Top quartlie")) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,".png")
    ggsave(savef, width=20, height=10, units="cm")

    # plot the low penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp =="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.05, .05),
                         breaks = seq(-0.05,0.05,0.01),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016), 
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June", 
           y="Change relative to 2009",
           title=outclab[iy],
           subtitle=plab[ix]) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,"_bottom.png")
    ggsave(savef, width=20, height=10, units="cm")
  }
}


outc <- c("refhhi3", "shsnf_used")
outclab <- c("SNF referral concentration", "Share of SNFs in the market used")
plab <- c("Predicted likelihood of penalty in 2012", "Predicted penalty rate in 2012", "Log Predicted penalty amount ($) in 2012")
pv <- c("ppst2012","ppr2012","lppd2012")

iy <- 0  
for (y in outc) {
  iy <- iy + 1
  ix <- 0
  
  for (x in pv) {
    ix <- ix + 1
    
    # plot the high & medium penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp !="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.03, .03),
                         breaks = seq(-0.03,0.03,0.01),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016),
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June",
           y="Change relative to 2009 and \nto low-penalty pressure hospitals",
                      title=outclab[iy],
           subtitle=plab[ix]) +
      scale_linetype_manual(values=c(1,2), name="", labels=c("Middle 2 quartiles",   "Top quartlie")) +
      scale_shape_discrete(name="", label=c("Middle 2 quartiles", "Top quartlie")) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,".png")
    ggsave(savef, width=20, height=10, units="cm")

    # plot the low penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp =="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.03, .03),
                         breaks = seq(-0.03,0.03,0.01),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016), 
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June", 
           y="Change relative to 2009",
           title=outclab[iy],
           subtitle=plab[ix]) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,"_bottom.png")
    ggsave(savef, width=20, height=10, units="cm")
  }
}


iy <- 0  
outc <- c( "ratio_nsnf")
outclab <- c("Ratio of the numbers of SNFs used in current year to previous year")
pv <- c("ppst2012","ppr2012","lppd2012")
for (y in outc) {
  iy <- iy + 1
  ix <- 0
  
  for (x in pv) {
    ix <- ix + 1
    
    # plot the high & medium penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp !="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.4, .4),
                         breaks = seq(-0.4,0.4,0.1),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016),
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June",
           y="Change relative to 2009 and \nto low-penalty pressure hospitals",
                      title=outclab[iy],
           subtitle=plab[ix]) +
      scale_linetype_manual(values=c(1,2), name="", labels=c("Middle 2 quartiles",   "Top quartlie")) +
      scale_shape_discrete(name="", label=c("Middle 2 quartiles", "Top quartlie")) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,".png")
    ggsave(savef, width=20, height=10, units="cm")

    # plot the low penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp =="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.4, .4),
                         breaks = seq(-0.4,0.4,0.1),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016), 
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June", 
           y="Change relative to 2009",
           title=outclab[iy],
           subtitle=plab[ix]) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,"_bottom.png")
    ggsave(savef, width=20, height=10, units="cm")
  }
}


outclab <- c("SNF referral concentration among SNFs used in the previous year")
outc <- c("refhhi_prevSNFs")
pv <- c("ppst2012","ppr2012","lppd2012")
# pv <- c("ppst2012")

iy <- 0  
for (y in outc) {
  iy <- iy + 1
  ix <- 0
  
  for (x in pv) {
    ix <- ix + 1
    
    # plot the high & medium penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp !="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.04, .04),
                         breaks = seq(-0.04,0.04,0.01),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016),
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June",
           y="Change relative to 2009 and \nto low-penalty pressure hospitals",
                      title=outclab[iy],
           subtitle=plab[ix]) +
      scale_linetype_manual(values=c(1,2), name="", labels=c("Middle 2 quartiles",   "Top quartlie")) +
      scale_shape_discrete(name="", label=c("Middle 2 quartiles", "Top quartlie")) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,".png")
    ggsave(savef, width=20, height=10, units="cm")

    # plot the low penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp =="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.04, .04),
                         breaks = seq(-0.04,0.04,0.01),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016), 
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June", 
           y="Change relative to 2009",
           title=outclab[iy],
           subtitle=plab[ix]) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,"_bottom.png")
    ggsave(savef, width=20, height=10, units="cm")
  }
}



outclab <- c("Share of previously used SNFs used again")
outc <- c("shsnf_used_again")
pv <- c("ppst2012","ppr2012","lppd2012")

iy <- 0
for (y in outc) {
  iy <- iy + 1
  ix <- 0
  
  for (x in pv) {
    ix <- ix + 1
    
    # plot the high & medium penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp !="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.13, .13),
                         breaks = seq(-0.1,0.1,0.05),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016),
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June",
           y="Change relative to 2009 and \nto low-penalty pressure hospitals",
                      title=outclab[iy],
           subtitle=plab[ix]) +
      scale_linetype_manual(values=c(1,2), name="", labels=c("Middle 2 quartiles",   "Top quartlie")) +
      scale_shape_discrete(name="", label=c("Middle 2 quartiles", "Top quartlie")) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,".png")
    ggsave(savef, width=20, height=10, units="cm")

    # plot the low penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp =="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.13, .13),
                         breaks = seq(-0.1,0.1,0.05),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016), 
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June", 
           y="Change relative to 2009",
           title=outclab[iy],
           subtitle=plab[ix]) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,"_bottom.png")
    ggsave(savef, width=20, height=10, units="cm")
  }
}

outclab <- c("Share of SNF referrals to previously used SNFs")
outc <- c("shref_usedbefore")
pv <- c("ppst2012","ppr2012","lppd2012")

iy <- 0  
for (y in outc) {
  iy <- iy + 1
  ix <- 0
  
  for (x in pv) {
    ix <- ix + 1
    
    # plot the high & medium penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp !="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.06, .06),
                         breaks = seq(-0.06,0.06,0.01),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016),
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June",
           y="Change relative to 2009 and \nto low-penalty pressure hospitals",
                      title=outclab[iy],
           subtitle=plab[ix]) +
      scale_linetype_manual(values=c(1,2), name="", labels=c("Middle 2 quartiles",   "Top quartlie")) +
      scale_shape_discrete(name="", label=c("Middle 2 quartiles", "Top quartlie")) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,".png")
    ggsave(savef, width=20, height=10, units="cm")

    # plot the low penalty pressure hospitals
    df2 <- df[df$outcome==y & df$pp==x & df$gp =="Bottom quartile",]
    ggplot(df2) +
      geom_errorbar(aes(x=fy, ymin=min95, ymax=max95, group=gp, linetype=gp), width=.1, position=pd, alpha=0.5) +
      geom_point(aes(x=fy, y=estimate, group=gp, shape=gp), width=.1, position=pd, size=3) +
      geom_line(aes(x=fy, y=estimate, linetype=gp), width=.1, position=pd)  +
      scale_y_continuous(limits=c(-.06, .06),
                         breaks = seq(-0.06,0.06,0.01),
                         minor_breaks = NULL) +
      scale_x_continuous(breaks = c(2010:2016), 
                         minor_breaks = NULL) +
      theme_bw(base_size=12) +
      geom_hline(aes(yintercept=0), colour="black", alpha=0.5) +
      labs(x="Year ending in June", 
           y="Change relative to 2009",
           title=outclab[iy],
           subtitle=plab[ix]) +
      theme(legend.position="bottom", 
            legend.title=element_blank(),
            panel.grid.major.x = element_blank())
    savef <- paste0("~/Dropbox/Research/VI/output/",y,"_",x,"_bottom.png")
    ggsave(savef, width=20, height=10, units="cm")
  }
}
    
```


# Descriptive analysis of the trend

## Trend in # discharges
```{r}
df.h <- ddply(df, .(provid,fy,size,condition), summarise, disch = mean(dischnum))

df.h2 <- summarySE(df.h, measurevar="disch", groupvars=c("fy","condition"))

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right

# Use 95% confidence interval instead of SEM
ggplot(df.h2, aes(x=fy, y=disch)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=disch-ci, ymax=disch+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,180)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean total number of discharges in a hospital",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/dischnum.png", width = 15, height=15, units="cm")

df.h3 <- summarySE(df.h, measurevar="disch", groupvars=c("size","fy","condition"))

ggplot(df.h3, aes(x=fy, y=disch, colour=size)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=disch-ci, ymax=disch+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,320)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean total number of discharges in a hospital",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/dischnum_bysize.png", width = 15, height=15, units="cm")
```


## Trend in share of discharges referred to PAC

don't exclude 2008
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/Medicare/hosp_fy_VI.csv")
df$condition <- factor(df$condition, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))
df$size <- factor(df$size, labels = c("30-100","101-300","301+"))

df$cond2 <- factor(ifelse(df$condition!="Hip/Knee",1,2), labels = c("AMI, HF, PN", "Hip/Knee"))
df$refhhi3[df$cond2=="Hip/Knee"] <- df$refhhi[df$cond2=="Hip/Knee"]

#create share of referrals
df$shref <- 100*df$dischnum_pac / df$dischnum

# create penalty pressure
df$pnlt3 <- factor(ifelse(df$pnltr13==0, 1,ifelse(df$pnltr13 >0.0034,2,3)), labels = c("Not penalized", "Penalized, bottom half", "Penalized, top half"))
# ddply(df, .(pnlt3), summarise, M=mean(pnltr13))
```


Mean share of referrals
```{r}
df.h2 <- summarySE(df, measurevar="shr", groupvars=c("pac","fy","condition"), na.rm=T)

df.h3 <- subset(df.h2, pac=="SNF")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=shr)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=shr-ci, ymax=shr+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean percentage of hospital discharges referred to SNF",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/shref_SNF.png", width = 15, height=15, units="cm")

df.h3 <- subset(df.h2, pac=="HHA" & fy >= 2011)

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=shr)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=shr-ci, ymax=shr+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_continuous(limits = c(2011,2016),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean percentage of hospital discharges referred to HHA",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/shref_HHA.png", width = 15, height=15, units="cm")

# by size
df.h4 <- summarySE(df.h, measurevar="shr", groupvars=c("pac","fy","condition","size"), na.rm=T)

df.h3 <- subset(df.h4, pac=="SNF")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=shr, colour=size)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=shr-ci, ymax=shr+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_continuous(limits = c(2008.8,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean percentage of hospital discharges referred to SNF",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/shref_SNF_bysize.png", width = 15, height=15, units="cm")

df.h3 <- subset(df.h4, pac=="HHA" & fy >= 2011)

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=shr, colour=size)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=shr-ci, ymax=shr+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_continuous(limits = c(2010.8,2016.2),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean percentage of hospital discharges referred to HHA",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/shref_HHA_bysize.png", width = 15, height=15, units="cm")

```

### growth of share of referrals by penalty
```{r}
df.h <- ddply(df, .(pac,provid,fy,pnlt3,condition), summarise, shref = mean(shref, na.rm=TRUE))
# df.h <- ddply(df, .(pac,provid,fy,pnltr13_p75,condition), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))

# calculate growth rate
df.h <- df.h[order(df.h$pac,df.h$condition,df.h$provid,df.h$fy),]
df.h2 <- ddply(df.h,.(pac, condition, provid),transform,
         Growth=c(NA,exp(diff(log(shref)))-1))
df.h2$Growth <- 100*df.h2$Growth
df.h2$Growth[is.infinite(df.h2$Growth)] <- NA 
summary(df.h2$Growth)

# aggregate mean growth
df.h3 <- summarySE(df.h2, measurevar="Growth", groupvars=c("pac","fy","condition","pnlt3"), na.rm=T)
df.h3 <- subset(df.h3, is.na(pnlt3)==F)
# df.h3$pnlt3 <- factor(df.h3$pnlt3, labels = c("Low penalty pressure", "High penalty pressure"))

df.h4 <- subset(df.h3, pac=="SNF")

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  # scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2008.8,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral share (%)",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size=8) +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grshref_SNF_bypnltprs.png", width = 15, height=15, units="cm")


df.h4 <- subset(df.h3, pac=="HHA" & fy >= 2011)

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + facet_grid(condition~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  # scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2011,2016.2),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of HHA referral concentration (%)",
       subtitle="By penalty rate in 2013 and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grshref_HHA_bypnltprs.png", width = 15, height=15, units="cm")

```


## Trend in PAC referral concentration 
plot raw means
```{r}
df.h <- ddply(df, .(pac,provid,fy,size,cond2), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))

# aggregate mean growth
df.h2 <- summarySE(df.h, measurevar="refhhi3", groupvars=c("pac","fy","cond2","size"), na.rm=T)

df.h3 <- subset(df.h2, pac=="SNF")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=size)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,0.5)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean SNF referral concentration",
       subtitle="By hospital size and condition") +
  theme_bw() +
    theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_SNF_bysize.png", width = 15, height=15, units="cm")

df.h3 <- subset(df.h2, pac=="HHA" & fy >= 2011)

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=size)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,0.7)) +
  scale_x_continuous(limits = c(2011,2016),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean HHA referral concentration",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_HHA_bysize.png", width = 15, height=15, units="cm")
```


### mean level by penalty status
```{r}
df <- read.csv("~/Dropbox/Research/VI/data/Medicare/hosp_fy_VI.csv")
# df <- subset(df, fy!=2008) # drop 2008 b/c it's only second half of 2008
df$condition <- factor(df$condition, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))
df$size <- factor(df$size, labels = c("30-100","101-300","301+"))

df$cond2 <- factor(ifelse(df$condition!="Hip/Knee",1,2), labels = c("AMI, HF, PN", "Hip/Knee"))
df$refhhi3[df$cond2=="Hip/Knee"] <- df$refhhi[df$cond2=="Hip/Knee"]

df$pnlt3 <- factor(ifelse(df$pnltr13==0, 1,ifelse(df$pnltr13 >0.0034,2,3)), labels = c("Not penalized", "Penalized, bottom half", "Penalized, top half"))
# ddply(df, .(pnlt3), summarise, M=mean(pnltr13))

df.h <- ddply(df, .(pac,provid,fy,pnlt3,cond2), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))
# df.h <- ddply(df, .(pac,provid,fy,pnltr13_p75,cond2), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))

# aggregate mean growth
df.h2 <- summarySE(df.h, measurevar="refhhi3", groupvars=c("pac","fy","cond2","pnlt3"), na.rm=T)

df.h3 <- subset(df.h2, pac=="SNF" & cond2!="Hip/Knee")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=pnlt3)) + 
  # facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(0,0.3)) +
  scale_x_continuous(limits = c(2007.8,2016),
                     breaks= seq(2008,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean SNF referral concentration for AMI, HF, PN",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size = 7) +
    theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_SNF_bypnlt3_3c.png", width = 10, height=7, units="cm")

df.h3 <- subset(df.h2, pac=="SNF" & cond2=="Hip/Knee")

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=pnlt3)) + 
  # facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(0,0.5)) +
  scale_x_continuous(limits = c(2007.8,2016),
                     breaks= seq(2008,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean SNF referral concentration for HK",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size = 7) +
    theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_SNF_bypnlt3_hk.png", width = 10, height=7, units="cm")


df.h3 <- subset(df.h2, pac=="HHA" & fy >= 2011)

# Use 95% confidence interval instead of SEM
ggplot(df.h3, aes(x=fy, y=refhhi3, colour=pnlt3)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=refhhi3-ci, ymax=refhhi3+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,0.7)) +
  scale_x_continuous(limits = c(2011,2016),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean HHA referral concentration",
       subtitle="By penalty rate in 2013 and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/refhhi3_HHA_bypnlt3.png", width = 15, height=15, units="cm")
```


Plot growth rate
```{r}
# calculate growth rate
df.h <- df.h[order(df.h$pac,df.h$cond2,df.h$provid,df.h$fy),]
df.h2 <- ddply(df.h,.(pac, cond2, provid),transform,
         Growth=c(NA,exp(diff(log(refhhi3)))-1))
df.h2$Growth <- 100*df.h2$Growth
df.h2$Growth[is.infinite(df.h2$Growth)] <- NA 
summary(df.h2$Growth)

# aggregate mean growth
df.h3 <- summarySE(df.h2, measurevar="Growth", groupvars=c("pac","fy","cond2"), na.rm=T)

df.h4 <- subset(df.h3, pac=="SNF")

ggplot(df.h4, aes(x=fy, y=Growth)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,20)) +
  scale_x_continuous(limits = c(2009,2016),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral concentration (%)",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_SNF.png", width = 15, height=15, units="cm")

df.h4 <- subset(df.h3, pac=="HHA" & fy >= 2011)

ggplot(df.h4, aes(x=fy, y=Growth)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0,20)) +
  scale_x_continuous(limits = c(2011,2016),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of HHA referral concentration (%)",
       subtitle="By condition") +
  theme_bw()
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_HHA.png", width = 15, height=15, units="cm")


# by size

# aggregate mean growth
df.h3 <- summarySE(df.h2, measurevar="Growth", groupvars=c("pac","fy","cond2","size"), na.rm=T)

df.h4 <- subset(df.h3, pac=="SNF")

ggplot(df.h4, aes(x=fy, y=Growth, colour=size)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2009,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral concentration (%)",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_SNF_bysize.png", width = 15, height=15, units="cm")

df.h4 <- subset(df.h3, pac=="HHA" & fy >= 2011)

ggplot(df.h4, aes(x=fy, y=Growth, colour=size)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2011,2016.2),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of HHA referral concentration (%)",
       subtitle="By hospital size and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Hospital size (beds)"))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_HHA.png", width = 15, height=15, units="cm")
```

### growth rate by penalty status
```{r}
df$pnlt3 <- factor(ifelse(df$pnltr13==0, 1,ifelse(df$pnltr13 >0.0034,2,3)), labels = c("Not penalized", "Penalized, bottom half", "Penalized, top half"))
# ddply(df, .(pnlt3), summarise, M=mean(pnltr13))
df.h <- ddply(df, .(pac,provid,fy,pnlt3,cond2), summarise, refhhi3 = mean(refhhi3, na.rm=TRUE))

# calculate growth rate
df.h <- df.h[order(df.h$pac,df.h$cond2,df.h$provid,df.h$fy),]
df.h2 <- ddply(df.h,.(pac, cond2, provid),transform,
         Growth=c(NA,exp(diff(log(refhhi3)))-1))
df.h2$Growth <- 100*df.h2$Growth
df.h2$Growth[is.infinite(df.h2$Growth)] <- NA 
summary(df.h2$Growth)

# aggregate mean growth
df.h3 <- summarySE(df.h2, measurevar="Growth", groupvars=c("pac","fy","cond2","pnlt3"), na.rm=T)
df.h3 <- subset(df.h3, is.na(pnlt3)==F)
# df.h3$pnlt3 <- factor(df.h3$pnlt3, labels = c("Low penalty pressure", "High penalty pressure"))

df.h4 <- subset(df.h3, pac=="SNF" & cond2!="Hip/Knee")

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + 
  # facet_grid(pnlt3~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2008.8,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral concentration for AMI, HF, PN (%)",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size=8) +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_SNF_bypnltprs_3c.png", width = 10, height=7, units="cm")

df.h4 <- subset(df.h3, pac=="SNF" & cond2=="Hip/Knee")

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + 
  # facet_grid(pnlt3~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2008.8,2016.2),
                     breaks= seq(2009,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of SNF referral concentration for HK (%)",
       subtitle="By penalty rate in 2013") +
  theme_bw(base_size=8) +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_SNF_bypnltprs_hk.png", width = 10, height=7, units="cm")


df.h4 <- subset(df.h3, pac=="HHA" & fy >= 2011)

ggplot(df.h4, aes(x=fy, y=Growth, colour=pnlt3)) + facet_grid(cond2~.) +
  geom_errorbar(aes(ymin=Growth-ci, ymax=Growth+ci), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd) +
  scale_y_continuous(limits = c(-20,20)) +
  scale_x_continuous(limits = c(2011,2016.2),
                     breaks= seq(2011,2016,1)) +
  labs(x="Fiscal Year ending in June", 
       y="",
       title="Mean growth of HHA referral concentration (%)",
       subtitle="By penalty pressure and condition") +
  theme_bw() +
  theme(legend.position="bottom") +
  guides(colour=guide_legend(title=""))
ggsave("~/Dropbox/Research/VI/gph/grrefhhi3_HHA_bypnltprs.png", width = 15, height=15, units="cm")

```

## relationship b/w penalty pressure & referral hhi
```{r}
test <- subset(df, pac=="SNF" & condition=="Heart Failure" )
table(test$fy)
test$std_pnltprs <- scale(test$pnltprs)

ggplot(test, aes(x=std_pnltprs, y=refhhi)) + facet_grid(fy~.) +
  geom_smooth() 

```







## Trend in VI by FY
HHA
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_VI_HHA_qtradj2.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")

# df$gp2 <- factor(df$gp, levels = c("pnlt_onlyhk15", "pnlt_hk15", "pnlt_nohk15"), labels=c("Penalized only for H/K", "Penalized for H/K", "Penalized for non H/K")) 

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' HHA referral concentration by condition",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hha_did2.png", width=15, height=10, units="cm")
```



## Trend in VI by quarters
HHA
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_VI_HHA_qtradj2.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")

# df$gp2 <- factor(df$gp, levels = c("pnlt_onlyhk15", "pnlt_hk15", "pnlt_nohk15"), labels=c("Penalized only for H/K", "Penalized for H/K", "Penalized for non H/K")) 

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' HHA referral concentration by condition",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hha_did2.png", width=15, height=10, units="cm")
```

SNF
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_VI_SNF_qtradj2.csv")

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")
summary(df)

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' SNF referral concentration by condition",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/snf_did2.png", width=15, height=10, units="cm")


# df$gp2 <- factor(df$gp, levels = c("pnlt_onlyhk15", "pnlt_hk15", "pnlt_nohk15"), labels=c("Penalized only for H/K", "Penalized for H/K", "Penalized for non H/K")) 

# ggplot(df, aes(fy, coef)) + facet_grid(.~gp2) +
#   geom_point(aes(shape=gp2), size=3, position=position_dodge(.9)) +
#   geom_line(position=position_dodge(.9)) +
#   geom_errorbar(aes(ymin = min95, ymax = max95), position=position_dodge(.9)) + 
#   geom_hline(aes(yintercept=0), linetype="dashed") + 
#   theme_bw() +
#   theme(legend.position="none") +
#   labs(title = "Trend in hospitals' SNF referral concentration for H/K patients by penalty status",
#        x="Year",
#        y="")
# ggsave("~/Dropbox/Research/VI/gph/snf_did.png")
```

## Trend in the share of referrals to PAC 
HHA
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_shref_HHA_qtradj.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")

# df$gp2 <- factor(df$gp, levels = c("pnlt_onlyhk15", "pnlt_hk15", "pnlt_nohk15"), labels=c("Penalized only for H/K", "Penalized for H/K", "Penalized for non H/K")) 

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' share of hospital discharges referred to HHA",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hha_did_shref.png", width=15, height=10, units="cm")
```

SNF
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_shref_SNF_qtradj.csv")

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")
summary(df)

ggplot(df, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Trend in hospitals' share of hospital discharges referred to SNF",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/snf_did_shref.png", width=15, height=10, units="cm")
```


## By the readmission risk, how did the readmission rate & integration change over time? 
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_DiD_qtr_iv_adj.csv")
df <- subset(df, iv=="rblack")

df$cond <- factor(df$cond, levels = c("AMI", "HF", "PN", "HK"), labels= c("AMI", "HF", "PN", "HK"))
                  # labels=c("AMI", "Heart Failure", "Pneumonia", "Hip/Knee"))
# df$iv <- factor(df$iv, levels = c("rblack", "ses_score", "rreadmit90"), c("% Black", "SES score", "90-day readmission"))
df$iv <- factor(df$iv, levels = c("rblack"), c("% Black"))
df$y <- factor(df$y, levels = c("refhhi", "rread30p"), c("Referral concentration", "30-day PAC readmission rate"))

df$yq <- paste0(df$yr, "-Q", df$qtr)
df$yqd <- as.yearqtr(df$yq, format = "%Y-Q%q")
summary(df)
```

### Using only the % blacks, 
```{r}
df2 <- subset(df, pac=="HHA" & y=="Referral concentration")

ggplot(df2, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on HHA referral concentration",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hha_impact_bytop3rd.png", width=15, height=15, units="cm")

df2 <- subset(df, pac=="SNF" & y=="Referral concentration")

ggplot(df2, aes(yqd, coef)) + facet_grid(cond~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on SNF referral concentration",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/snf_impact_bytop3rd.png", width=15, height=15, units="cm")

```

### Using different predictors of initial risk penalty
HHA
```{r}
df2 <- subset(df, cond=="HK" & pac=="HHA")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to HHA",
       subtitle = "Hip/Knee",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hk_hha_impact_bytop3rd.png", width=15, height=15, units="cm")



df2 <- subset(df, cond=="AMI" & pac=="HHA")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to HHA",
       subtitle = "AMI",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/ami_hha_impact_bytop3rd.png", width=15, height=15, units="cm")


df2 <- subset(df, cond=="HF" & pac=="HHA")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to HHA",
       subtitle = "HF",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hf_hha_impact_bytop3rd.png", width=15, height=15, units="cm")


df2 <- subset(df, cond=="PN" & pac=="HHA")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to HHA",
       subtitle = "Pneumonia",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/pn_hha_impact_bytop3rd.png", width=15, height=15, units="cm")
```

SNF
```{r}
df2 <- subset(df, cond=="HK" & pac=="SNF")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "Hip/Knee",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hk_SNF_impact_bytop3rd.png", width=15, height=20, units="cm")



df2 <- subset(df, cond=="AMI" & pac=="SNF")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "AMI",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/ami_SNF_impact_bytop3rd.png", width=15, height=15, units="cm")


df2 <- subset(df, cond=="HF" & pac=="SNF")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "HF",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/hf_SNF_impact_bytop3rd.png", width=15, height=15, units="cm")


df2 <- subset(df, cond=="PN" & pac=="SNF")

ggplot(df2, aes(yqd, coef, colour = y)) + facet_grid(iv~.) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "Pneumonia",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/pn_SNF_impact_bytop3rd.png", width=15, height=15, units="cm")
```

## Do initial risk of factors predict the penalty ERRs?
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/penaltystatus_iv.csv")
df$top3rd_rblack <- factor(df$top3rd_rblack)
df$top3rd_rnonwhite <- factor(df$top3rd_rnonwhite)
df$top3rd_rread30 <- factor(df$top3rd_rread30)
df$top3rd_ses_score <- factor(df$top3rd_ses_score)

df$penalized <- factor(df$pnltr > 0)

df2 <- subset(df, err_!=0 & fy < 2017)

df2$fy <- factor(df2$fy)

# black is pretty much a linear predictor
ggplot(df2, aes(x=rblack, y=err_, colour=fy)) + facet_grid(.~condition) +
  geom_smooth()  theme_bw(base_size = 11) +
  theme(legend.position="bottom") +
  labs(title = "Impact of initial penalty risk on 30-day readmission rates and \nreferral concentration among patients referred to SNF",
       subtitle = "Pneumonia",
       x="Quarter",
       y="")
ggsave("~/Dropbox/Research/VI/gph/pn_SNF_impact_bytop3rd.png", width=15, height=15, units="cm")

ggplot(df2, aes(x=rblack, colour=fy, linetype=penalized)) + facet_grid(condition~.) +
  geom_density() +
theme_bw(base_size = 11) +
  theme(legend.position="bottom")

ggplot(df2, aes(x=rnonwhite, y=err_, colour=fy)) + facet_grid(condition~.) +
  geom_smooth()

ggplot(df2, aes(x=rread30, y=err_, colour=fy, linetype=penalized)) +
  geom_smooth()

ggplot(df2, aes(x=ses_score, y=err_, colour=fy, linetype=penalized)) +
  geom_smooth()

```

## Fiscal-year level analysis
H/K
```{r}
df  <- read.csv("/Users/kimk13/Dropbox/Research/VI/data/DIDest/coef_DiD_fy_pnltprs_hk.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df$est <- factor(df$est, labels = c("Top 3rd penalty pressure for H/K", "Rest"))

df2 <- subset(df, y=="refhhi")

ggplot(df2, aes(fy, coef, colour=est, linetype=est)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in hospitals' H/K referral concentration \nin top 3rd of penalty pressure compared to other penatly conditions",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhi.png", width=15, height=10, units="cm")


df2 <- subset(df, y=="refhhigr")

ggplot(df2, aes(fy, coef, colour=est, linetype=est)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in growth (%) of hospitals' H/K referral concentration \nin top 3rd of penalty pressure compared to other penatly conditions",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhigr.png", width=15, height=10, units="cm")
```

Other conditions (Ami, PN, HF)
```{r}
df  <- read.csv("~/Dropbox/Research/VI/data/DIDest/coef_DiD_fy_pnltprs_other.csv")
# if use coef_VI_HHA_qtradj.csv, data used for esitmation includes refHHI = 1 b/c dischnum_pac=1 

df2 <- subset(df, y=="refhhi" & cond=="AMI")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in hospitals' AMI referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhi_AMI.png", width=15, height=10, units="cm")

df2 <- subset(df, y=="refhhi" & cond=="HF")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in hospitals' HF referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhi_HF.png", width=15, height=10, units="cm")

df2 <- subset(df, y=="refhhi" & cond=="PN")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in hospitals' PN referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhi_PN.png", width=15, height=10, units="cm")



df2 <- subset(df, y=="refhhigr" & cond=="AMI")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in growth (%) of hospitals' AMI referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhigr_AMI.png", width=15, height=10, units="cm")

df2 <- subset(df, y=="refhhigr" & cond=="HF")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in growth (%) of hospitals' HF referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhigr_HF.png", width=15, height=10, units="cm")

df2 <- subset(df, y=="refhhigr" & cond=="PN")

ggplot(df2, aes(fy, coef)) + facet_grid(.~pac) +
  geom_point(size=3) +
  geom_line() +
  # geom_errorbar(aes(ymin = min95, ymax = max95)) + 
  geom_ribbon(aes(ymin = min95, ymax = max95), alpha=0.2) + 
  geom_hline(aes(yintercept=0), linetype="dashed") + 
  theme_bw(base_size = 10) +
  theme(legend.position="bottom",
        legend.title=element_blank()) +
  labs(title = "Trend in growth (%) of hospitals' PN referral concentration \nin top 3rd of penalty pressure",
       x="FY",
       y="")
ggsave("~/Dropbox/Research/VI/gph/did_fy_refhhigr_PN.png", width=15, height=10, units="cm")


```
